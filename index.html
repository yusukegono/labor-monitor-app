<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Labor Monitor</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0D1F1A">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ==========================================================
   CSS VARIABLES
   ========================================================== */
:root {
  --bg: #0D1F1A;
  --surface: #132B23;
  --surface2: #1A3B2F;
  --green: #00A862;
  --green-bright: #00D97E;
  --gold: #F0C040;
  --red: #FF4D4D;
  --orange: #FF9020;
  --text: #E8F5EE;
  --text-dim: #7AB898;
  --border: #254D3A;
  --radius: 14px;
  --radius-sm: 8px;
  --font-display: 'Bebas Neue', sans-serif;
  --font-body: 'Noto Sans JP', sans-serif;
  --font-mono: 'DM Mono', monospace;
}

/* ==========================================================
RESET & BASE
========================================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; background: var(â€“bg); color: var(â€“text); font-family: var(â€“font-body); overflow-x: hidden; }

/* ==========================================================
HEADER
========================================================== */
.header {
background: linear-gradient(135deg, #0A1A15 0%, #132B23 100%);
border-bottom: 1px solid var(â€“border);
padding: 16px 20px 12px;
display: flex; align-items: center; justify-content: space-between;
position: sticky; top: 0; z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.sblogo {
width: 40px; height: 40px; background: var(â€“green); border-radius: 50%;
display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.sblogo svg { width: 24px; height: 24px; }
.store-name { font-size: 1rem; font-weight: 700; letter-spacing: 0.05em; cursor: pointer; }
.store-tag {
display: none; background: rgba(0,168,98,0.2); border: 1px solid var(â€“green);
border-radius: 20px; padding: 2px 10px; font-size: 0.65rem;
color: var(â€“green-bright); font-weight: 700;
}
.store-tag.visible { display: inline; }
.clock-box { text-align: right; }
.clock { font-family: var(â€“font-display); font-size: 2rem; color: var(â€“green-bright); letter-spacing: 0.05em; line-height: 1; }
.date-str { font-size: 0.65rem; color: var(â€“text-dim); }

/* Live badge */
.live-badge {
display: inline-flex; align-items: center; gap: 5px; font-size: 0.65rem;
color: var(â€“green-bright); background: rgba(0,216,126,0.12);
border: 1px solid rgba(0,216,126,0.3); border-radius: 20px; padding: 3px 10px;
}
.live-dot {
width: 6px; height: 6px; background: var(â€“green-bright); border-radius: 50%;
animation: pulse 1.5s infinite;
}
@keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.3; } }

/* ==========================================================
TABS
========================================================== */
.tabs { display: flex; background: var(â€“surface); border-bottom: 1px solid var(â€“border); }
.tab {
flex: 1; padding: 12px 8px; text-align: center; font-size: 0.75rem;
font-weight: 500; color: var(â€“text-dim); cursor: pointer;
border-bottom: 2px solid transparent; transition: all 0.2s;
}
.tab.active { color: var(â€“green-bright); border-bottom-color: var(â€“green-bright); background: var(â€“surface2); }

/* ==========================================================
PAGE CONTAINER
========================================================== */
.page { display: none; padding: 16px; max-width: 900px; margin: 0 auto; }
.page.active { display: block; }

/* ==========================================================
CARDS & FIELDS
========================================================== */
.card {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: var(â€“radius); padding: 18px; margin-bottom: 14px;
}
.card-title {
font-size: 0.65rem; font-weight: 700; letter-spacing: 0.15em;
text-transform: uppercase; color: var(â€“green); margin-bottom: 14px;
}
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.field label { display: block; font-size: 0.72rem; color: var(â€“text-dim); margin-bottom: 5px; }
.field input, .field select {
width: 100%; background: var(â€“bg); border: 1.5px solid var(â€“border);
border-radius: var(â€“radius-sm); color: var(â€“text);
font-family: var(â€“font-mono); font-size: 0.9rem;
padding: 10px 12px; outline: none; transition: border-color 0.2s;
-webkit-appearance: none;
}
.field input:focus, .field select:focus { border-color: var(â€“green); }
.field select option { background: var(â€“bg); }

/* ==========================================================
METRIC CARDS
========================================================== */
.metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
.metric-card {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: var(â€“radius); padding: 16px; text-align: center;
position: relative; overflow: hidden;
}
.metric-card::before {
content: â€˜â€™; position: absolute; top: 0; left: 0; right: 0; height: 3px;
background: var(â€“green);
}
.metric-card.warn::before { background: var(â€“orange); }
.metric-card.danger::before { background: var(â€“red); }
.metric-card.ok::before { background: var(â€“green-bright); }
.metric-label {
font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase;
color: var(â€“text-dim); margin-bottom: 6px;
}
.metric-value {
font-family: var(â€“font-display); font-size: 2.8rem; line-height: 1;
color: var(â€“green-bright);
}
.metric-value.warn { color: var(â€“orange); }
.metric-value.danger { color: var(â€“red); }
.metric-unit { font-size: 0.7rem; color: var(â€“text-dim); margin-top: 3px; }

/* ==========================================================
GAUGE
========================================================== */
.gauge-wrap { margin-bottom: 14px; }
.gauge-header {
display: flex; justify-content: space-between;
font-size: 0.72rem; color: var(â€“text-dim); margin-bottom: 6px;
}
.gauge-track {
background: var(â€“surface2); border-radius: 20px; height: 28px;
overflow: hidden; position: relative; border: 1px solid var(â€“border);
}
.gauge-fill {
height: 100%; border-radius: 20px; display: flex; align-items: center;
justify-content: flex-end; padding-right: 12px;
transition: width 0.8s cubic-bezier(0.34,1.2,0.64,1), background 0.5s;
min-width: 2px;
}
.gauge-fill span { font-family: var(â€“font-display); font-size: 1rem; color: white; }
.gauge-ticks { display: flex; justify-content: space-between; margin-top: 4px; }
.gauge-tick { font-family: var(â€“font-mono); font-size: 0.6rem; color: var(â€“text-dim); }

/* ==========================================================
VERDICT BANNER
========================================================== */
.verdict {
border-radius: 12px; padding: 14px 16px; margin-bottom: 14px;
font-size: 0.88rem; font-weight: 500; display: flex; gap: 10px;
align-items: flex-start; border: 1.5px solid;
}
.verdict.ok     { background: #0D2D1A; border-color: #1A6B3A; color: #5CE88A; }
.verdict.warn   { background: #2D1E00; border-color: #7A5000; color: #FFB020; }
.verdict.danger { background: #2D0D0D; border-color: #7A2020; color: #FF6060; }
.verdict-icon { font-size: 1.3rem; flex-shrink: 0; margin-top: -2px; }

/* ==========================================================
PARTNER LIST
========================================================== */
.partner-list { display: flex; flex-direction: column; gap: 8px; }
.partner-row {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: 10px; padding: 12px 14px; display: flex;
align-items: center; gap: 10px;
}
.partner-name { font-weight: 500; font-size: 0.88rem; min-width: 80px; flex-shrink: 0; }
.partner-info { flex: 1; display: flex; gap: 8px; flex-wrap: wrap; }
.pinfo { font-family: var(â€“font-mono); font-size: 0.75rem; color: var(â€“text-dim); }
.pinfo span { color: var(â€“text); }
.partner-hours {
font-family: var(â€“font-display); font-size: 1.5rem;
color: var(â€“green-bright); min-width: 52px; text-align: right;
}
.partner-hours.warn { color: var(â€“orange); }

/* ==========================================================
ADD PARTNER FORM
========================================================== */
.add-form {
background: var(â€“surface2); border: 1px dashed var(â€“border);
border-radius: 12px; padding: 14px; margin-bottom: 14px;
}
.add-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

/* ==========================================================
BUTTONS
========================================================== */
.btn {
border: none; border-radius: 10px; padding: 12px 18px;
font-family: var(â€“font-body); font-size: 0.85rem; font-weight: 700;
cursor: pointer; transition: all 0.15s; letter-spacing: 0.05em;
}
.btn-primary { background: var(â€“green); color: white; width: 100%; }
.btn-primary:hover { background: var(â€“green-bright); }
.btn-small {
background: var(â€“surface2); color: var(â€“text); border: 1px solid var(â€“border);
padding: 8px 14px; font-size: 0.78rem;
}
.btn-small:hover { border-color: var(â€“green); color: var(â€“green-bright); }
.btn-danger { background: transparent; color: var(â€“red); border: 1px solid var(â€“red); }
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
.remove-btn {
background: none; border: 1px solid var(â€“border); border-radius: 6px;
color: var(â€“text-dim); padding: 4px 8px; cursor: pointer; font-size: 0.7rem;
}
.remove-btn:hover { border-color: var(â€“red); color: var(â€“red); }
.edit-btn {
background: none; border: 1px solid var(â€“green); border-radius: 6px;
color: var(â€“green); padding: 4px 8px; cursor: pointer; font-size: 0.7rem;
flex-shrink: 0;
}
.edit-btn:hover { background: var(â€“green); color: white; }
.save-btn {
background: var(â€“gold); color: #1A1000; font-weight: 700; border: none;
border-radius: 10px; padding: 13px; width: 100%; font-size: 0.9rem;
cursor: pointer; margin-top: 4px; transition: opacity 0.2s;
}
.save-btn:hover { opacity: 0.88; }

/* ==========================================================
HISTORY
========================================================== */
.history-entry {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: 12px; padding: 14px; margin-bottom: 10px;
}
.hist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.hist-date { font-weight: 700; font-size: 0.9rem; }
.hist-guide { font-family: var(â€“font-mono); font-size: 0.72rem; color: var(â€“text-dim); }
.hist-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.hist-metric { text-align: center; }
.hist-val { font-family: var(â€“font-display); font-size: 1.4rem; }
.hist-val.ok { color: var(â€“green-bright); }
.hist-val.warn { color: var(â€“orange); }
.hist-val.danger { color: var(â€“red); }
.hist-lbl { font-size: 0.6rem; color: var(â€“text-dim); }
.delete-hist {
background: none; border: none; color: var(â€“text-dim);
cursor: pointer; font-size: 0.8rem; padding: 4px 8px;
}
.delete-hist:hover { color: var(â€“red); }

/* ==========================================================
MODAL (single definition)
========================================================== */
.modal-overlay {
display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75);
z-index: 200; align-items: flex-start; justify-content: center;
padding: 16px; overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: 16px; width: 100%; max-width: 420px; margin: auto;
display: flex; flex-direction: column;
animation: modalSlideUp 0.2s ease;
}
@keyframes modalSlideUp {
from { transform: translateY(20px); opacity: 0; }
to   { transform: translateY(0);    opacity: 1; }
}
.modal-body { padding: 24px 24px 0 24px; }
.modal-footer {
padding: 16px 24px 24px 24px; position: sticky; bottom: 0;
background: var(â€“surface); border-top: 1px solid var(â€“border);
border-radius: 0 0 16px 16px;
}
.modal-title {
font-size: 0.88rem; font-weight: 700; color: var(â€“green-bright);
margin-bottom: 14px; letter-spacing: 0.05em;
}
.modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 10px; }
.btn-save {
background: var(â€“green); color: white; border: none; border-radius: 10px;
padding: 12px; flex: 1; font-size: 0.88rem; font-weight: 700;
cursor: pointer; font-family: var(â€“font-body);
}
.btn-save:hover { background: var(â€“green-bright); }
.btn-cancel {
background: var(â€“surface2); color: var(â€“text-dim); border: 1px solid var(â€“border);
border-radius: 10px; padding: 12px; flex: 1; font-size: 0.88rem;
cursor: pointer; font-family: var(â€“font-body);
}

/* ==========================================================
EMPTY STATE
========================================================== */
.empty { text-align: center; color: var(â€“text-dim); padding: 40px 20px; font-size: 0.85rem; }

/* ==========================================================
RESPONSIVE
========================================================== */
@media (max-width: 500px) {
.metrics-grid { grid-template-columns: 1fr 1fr; }
.row3 { grid-template-columns: 1fr 1fr; }
.hist-metrics { grid-template-columns: repeat(2, 1fr); }
.metric-value { font-size: 2.2rem; }
}
</style>

</head>
<body>

<!-- ===== HEADER ===== -->

<div class="header">
  <div class="header-left">
    <div class="sblogo">
      <svg viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" fill="white" opacity="0.15"/>
        <path d="M12 4C8.13 4 5 7.13 5 11c0 2.76 1.57 5.16 3.88 6.38L8.5 20h7l-.38-2.62C17.43 16.16 19 13.76 19 11c0-3.87-3.13-7-7-7z" fill="white" opacity="0.9"/>
        <ellipse cx="12" cy="10.5" rx="3" ry="3.5" fill="#00A862"/>
      </svg>
    </div>
    <div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="store-name" id="hdr-store" onclick="showTab('setup')" title="ã‚¿ãƒƒãƒ—ã—ã¦åº—èˆ—åã‚’å¤‰æ›´">Labor Monitor</div>
        <span class="store-tag" id="hdr-store-tag"></span>
      </div>
      <div style="font-size:0.65rem;color:var(--text-dim);margin-top:1px;">
        <span class="live-badge"><span class="live-dot"></span>LIVE</span>
      </div>
    </div>
  </div>
  <div class="clock-box">
    <div class="clock" id="clock">--:--:--</div>
    <div class="date-str" id="date-str">----/--/--</div>
  </div>
</div>

<!-- ===== TABS ===== -->

<div class="tabs">
  <div class="tab active" data-tab="monitor" onclick="showTab('monitor')">ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒ¼</div>
  <div class="tab" data-tab="partners" onclick="showTab('partners')">ğŸ‘¥ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
  <div class="tab" data-tab="setup" onclick="showTab('setup')">âš™ï¸ è¨­å®š</div>
  <div class="tab" data-tab="history" onclick="showTab('history')">ğŸ“… å±¥æ­´</div>
</div>

<!-- ========== MONITOR PAGE ========== -->

<div class="page active" id="page-monitor">

  <div id="store-setup-banner" style="display:none;border-radius:10px;padding:12px 16px;margin-bottom:12px;background:#1A2D1A;border:1.5px solid var(--green);color:var(--green-bright);font-size:0.82rem;font-weight:500;cursor:pointer;" onclick="showTab('setup')">
    âš™ï¸ ã¾ãšåº—èˆ—åã‚’è¨­å®šã—ã¾ã—ã‚‡ã† â†’ <u>è¨­å®šã‚¿ãƒ–ã‚’ã‚¿ãƒƒãƒ—</u>
  </div>

  <div id="biz-status-bar" style="border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:0.82rem;font-weight:500;align-items:center;gap:8px;display:none;"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
    <div class="field">
      <label>ğŸ• å–¶æ¥­é–‹å§‹</label>
      <input type="time" id="mon-open" oninput="onBizTimeChange()">
    </div>
    <div class="field">
      <label>ğŸ•™ å–¶æ¥­çµ‚äº†</label>
      <input type="time" id="mon-close" oninput="onBizTimeChange()">
    </div>
    <div class="field">
      <label>çµŒéæ™‚é–“</label>
      <div id="biz-elapsed" style="background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-family:'DM Mono',monospace;font-size:0.9rem;color:var(--green-bright);">--h --m</div>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
    <div class="field" style="flex:1;min-width:140px;">
      <label>ç¾åœ¨ã®å£²ä¸Š (å††)</label>
      <input type="number" id="mon-sales" placeholder="552042" inputmode="numeric" oninput="refreshMonitor()">
    </div>
    <div class="field" style="flex:1;min-width:120px;">
      <label>ã‚¬ã‚¤ãƒ‰å˜ä¾¡ (å††/h)</label>
      <input type="number" id="mon-guide" placeholder="7665" inputmode="numeric" oninput="refreshMonitor()">
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card" id="mc-guide">
      <div class="metric-label">ã‚¬ã‚¤ãƒ‰æ™‚é–“ï¼ˆé©æ­£ã‚ªãƒšæ™‚é–“ï¼‰</div>
      <div class="metric-value" id="val-guide-h">--</div>
      <div class="metric-unit">æ™‚é–“</div>
    </div>
    <div class="metric-card" id="mc-actual">
      <div class="metric-label">å®Ÿã‚ªãƒšæ™‚é–“ï¼ˆéã‚ªãƒšé™¤å¤–æ¸ˆï¼‰</div>
      <div class="metric-value" id="val-actual-h">0.0</div>
      <div class="metric-unit">æ™‚é–“</div>
    </div>
    <div class="metric-card" id="mc-ratio">
      <div class="metric-label">ã‚¬ã‚¤ãƒ‰æ¯”</div>
      <div class="metric-value" id="val-ratio">--%</div>
      <div class="metric-unit">å®ŸåŠ´åƒ Ã· ã‚¬ã‚¤ãƒ‰</div>
    </div>
    <div class="metric-card" id="mc-diff">
      <div class="metric-label">éä¸è¶³æ™‚é–“</div>
      <div class="metric-value" id="val-diff">--</div>
      <div class="metric-unit">æ™‚é–“ï¼ˆï¼‹è¶…é ï¼ âˆ’ä½™å‰°ï¼‰</div>
    </div>
    <!-- éã‚ªãƒšå†…è¨³: 6åˆ—ã«ä¿®æ­£ -->
    <div class="metric-card" style="grid-column:1/-1;background:var(--surface2);">
      <div class="metric-label" style="margin-bottom:10px;">éã‚ªãƒšæ™‚é–“å†…è¨³ â€” ã‚¬ã‚¤ãƒ‰æ¯”è¨ˆç®—ã‹ã‚‰é™¤å¤–æ¸ˆã¿ âœ“</div>
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;text-align:center;">
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-break">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">ä¼‘æ†©(h)</div></div>
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-meeting">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">MTG(h)</div></div>
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-training">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">è‚²æˆ(h)</div></div>
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-exp">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">EXP(h)</div></div>
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-cln">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">CLN(h)</div></div>
        <div><div style="font-family:var(--font-display);font-size:1.4rem;color:var(--gold);" id="nonope-mgt">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">MGT(h)</div></div>
      </div>
    </div>
  </div>

  <div class="gauge-wrap">
    <div class="gauge-header">
      <span>ã‚¬ã‚¤ãƒ‰æ¯”ã‚²ãƒ¼ã‚¸</span>
      <span id="gauge-text-mon">--</span>
    </div>
    <div class="gauge-track">
      <div class="gauge-fill" id="gauge-mon" style="width:0%;background:var(--green)">
        <span id="gauge-mon-label"></span>
      </div>
    </div>
    <div class="gauge-ticks">
      <span class="gauge-tick">0%</span>
      <span class="gauge-tick">50%</span>
      <span class="gauge-tick" style="color:var(--green-bright);">100%</span>
      <span class="gauge-tick" style="color:var(--orange);">120%</span>
      <span class="gauge-tick" style="color:var(--red);">150%</span>
    </div>
  </div>

  <div id="verdict-mon"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
    <div class="card" style="margin:0;">
      <div class="metric-label" style="margin-bottom:4px;">å‡ºå‹¤äººæ•°ï¼ˆé€€å‹¤æ¸ˆå«ï¼‰</div>
      <div style="font-family:var(--font-display);font-size:2rem;color:var(--gold);" id="val-headcount">0</div>
      <div class="metric-unit">å <span style="font-size:0.65rem;color:var(--text-dim);">é€€å‹¤æ¸ˆ <span id="val-retired-h">0.0</span>h åŠ ç®—ä¸­</span></div>
    </div>
    <div class="card" style="margin:0;">
      <div class="metric-label" style="margin-bottom:4px;">æ¬¡å›ãƒ•ãƒ«æ›´æ–°ã¾ã§</div>
      <div style="font-family:var(--font-display);font-size:2rem;color:var(--text-dim);" id="val-countdown">5:00</div>
      <div class="metric-unit">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§å†æç”»</div>
    </div>
  </div>

<button class="save-btn" onclick="saveSnapshot()">ğŸ“¸ ã“ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>

</div>

<!-- ========== PARTNERS PAGE ========== -->

<div class="page" id="page-partners">

  <div class="add-form">
    <div class="card-title">ï¼‹ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¿½åŠ </div>
    <div class="add-form-grid">
      <div class="field">
        <label>æ°å</label>
        <input type="text" id="add-name" placeholder="å±±ç”° èŠ±å­">
      </div>
      <div class="field">
        <label>å‡ºç¤¾æ™‚åˆ»</label>
        <input type="time" id="add-start">
      </div>
      <div class="field">
        <label>ç¾åœ¨ã¾ã§ã®ä¼‘æ†© (åˆ†)</label>
        <input type="number" id="add-break" placeholder="0" inputmode="numeric" min="0" max="480">
      </div>
      <div class="field">
        <label>é€€ç¤¾äºˆå®šæ™‚åˆ»</label>
        <input type="time" id="add-end">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addPartner()">è¿½åŠ ã™ã‚‹</button>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:0 4px;">
    <div class="card-title" style="margin:0;">å‡ºå‹¤ä¸­ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ <span id="partner-count" style="color:var(--gold);"></span></div>
    <button onclick="clearAllPartners()" style="background:#2D0D0D;border:1.5px solid var(--red);color:var(--red);border-radius:8px;padding:7px 14px;font-size:0.78rem;font-weight:700;cursor:pointer;font-family:var(--font-body);">ğŸ—‘ å…¨å“¡å‰Šé™¤</button>
  </div>
  <div class="partner-list" id="partner-list">
    <div class="empty" id="partner-empty">ã¾ã èª°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
  </div>
</div>

<!-- ========== SETUP PAGE ========== -->

<div class="page" id="page-setup">
  <div class="card">
    <div class="card-title">ğŸª åº—èˆ—è¨­å®šï¼ˆå…¨å›½ã©ã®åº—èˆ—ã§ã‚‚ä½¿ãˆã¾ã™ï¼‰</div>
    <div class="row2">
      <div class="field">
        <label>åº—èˆ—å</label>
        <input type="text" id="cfg-store" placeholder="ä¾‹ï¼šæ¸‹è°·åº—ã€æ–°å®¿å—å£åº— ãªã©" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¬ã‚¤ãƒ‰å˜ä¾¡ (å††/h)</label>
        <input type="number" id="cfg-guide" value="7665" inputmode="numeric" oninput="saveConfig()">
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</div>
    <div class="row3">
      <div class="field">
        <label>æ³¨æ„ãƒ©ã‚¤ãƒ³ (%)</label>
        <input type="number" id="cfg-warn" value="105" inputmode="numeric" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>å±é™ºãƒ©ã‚¤ãƒ³ (%)</label>
        <input type="number" id="cfg-danger" value="115" inputmode="numeric" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>ãƒ•ãƒ«æ›´æ–°é–“éš” (ç§’)</label>
        <input type="number" id="cfg-interval" value="300" inputmode="numeric" oninput="saveConfig()">
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div class="btn-row">
      <button class="btn btn-small" onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn btn-small" onclick="clearToday()">ğŸ”„ æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn btn-danger btn-small" onclick="clearAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- ========== HISTORY PAGE ========== -->

<div class="page" id="page-history">
  <div id="history-list">
    <div class="empty" id="history-empty">ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </div>
</div>

<!-- ========== EDIT MODAL ========== -->

<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-body">
      <div class="modal-title">âœï¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’ç·¨é›†</div>
      <input type="hidden" id="edit-id">
      <div class="modal-grid">
        <div class="field" style="grid-column:1/-1;">
          <label>æ°å</label>
          <input type="text" id="edit-name">
        </div>
        <div class="field">
          <label>å‡ºç¤¾æ™‚åˆ»</label>
          <input type="time" id="edit-start">
        </div>
        <div class="field">
          <label>é€€ç¤¾äºˆå®šæ™‚åˆ»</label>
          <input type="time" id="edit-end">
        </div>
        <div class="field">
          <label>ğŸ›Œ ä¼‘æ†© (åˆ†)</label>
          <input type="number" id="edit-break" min="0" max="480" inputmode="numeric">
        </div>
        <div class="field">
          <label>ğŸ“‹ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚° (åˆ†)</label>
          <input type="number" id="edit-meeting" min="0" max="480" inputmode="numeric">
        </div>
        <div class="field">
          <label>ğŸŒ± è‚²æˆ (åˆ†)</label>
          <input type="number" id="edit-training" min="0" max="480" inputmode="numeric">
        </div>
        <div class="field">
          <label>âœ¨ ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ (åˆ†)</label>
          <input type="number" id="edit-experience" min="0" max="480" inputmode="numeric">
        </div>
        <div class="field">
          <label>ğŸ§¹ ã‚¯ãƒ¬ãƒªãƒã‚¹ (åˆ†)</label>
          <input type="number" id="edit-cleanliness" min="0" max="480" inputmode="numeric">
        </div>
        <div class="field">
          <label>ğŸ’¼ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ (åˆ†)</label>
          <input type="number" id="edit-management" min="0" max="480" inputmode="numeric">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-save" onclick="saveEdit()">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
//  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¹ãƒ†ãƒ¼ãƒˆï¼ˆå˜ä¸€ã®çŠ¶æ…‹ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
// ============================================================
const App = {
  // --- ãƒ‡ãƒ¼ã‚¿ ---
  partners: [],
  history: [],
  config: {
    store: '',
    defaultGuide: 7665,
    warnLine: 105,
    dangerLine: 115,
    intervalSec: 300,
  },
  retiredHours: 0,
  lastActiveDate: '', // æ—¥ä»˜å¤‰æ›´æ¤œçŸ¥ç”¨

  // --- ã‚¿ã‚¤ãƒãƒ¼ID ---
  _fullRefreshTimer: null,
  _countdownTimer: null,
  _countdownSec: 300,

  // ============================================================
  //  æ°¸ç¶šåŒ– (localStorage)
  // ============================================================
  STORAGE_KEYS: {
    partners:     'sbcj_partners',
    history:      'sbcj_history',
    config:       'sbcj_config',
    retiredHours: 'sbcj_retiredHours',
    lastDate:     'sbcj_lastActiveDate',
    bizOpen:      'sbcj_bizOpen',
    bizClose:     'sbcj_bizClose',
    sales:        'sbcj_sales',
  },

  persist() {
    try {
      const sk = this.STORAGE_KEYS;
      localStorage.setItem(sk.partners, JSON.stringify(this.partners));
      localStorage.setItem(sk.history, JSON.stringify(this.history));
      localStorage.setItem(sk.config, JSON.stringify(this.config));
      localStorage.setItem(sk.retiredHours, String(this.retiredHours));
      localStorage.setItem(sk.lastDate, this.lastActiveDate);
      // å–¶æ¥­æ™‚é–“ãƒ»å£²ä¸Šã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³è·¨ãä¿æŒ
      localStorage.setItem(sk.bizOpen, document.getElementById('mon-open').value || '');
      localStorage.setItem(sk.bizClose, document.getElementById('mon-close').value || '');
      localStorage.setItem(sk.sales, document.getElementById('mon-sales').value || '');
    } catch (e) { /* QuotaExceededç­‰ã¯é™ã‹ã«ç„¡è¦– */ }
  },

  load() {
    try {
      const sk = this.STORAGE_KEYS;
      const p = localStorage.getItem(sk.partners);
      const h = localStorage.getItem(sk.history);
      const c = localStorage.getItem(sk.config);
      if (p) this.partners = JSON.parse(p);
      if (h) this.history = JSON.parse(h);
      if (c) this.config = { ...this.config, ...JSON.parse(c) };
      const r = localStorage.getItem(sk.retiredHours);
      if (r) this.retiredHours = parseFloat(r) || 0;
      this.lastActiveDate = localStorage.getItem(sk.lastDate) || '';
    } catch (e) { /* ç ´æãƒ‡ãƒ¼ã‚¿ã¯åˆæœŸå€¤ã§ç¶šè¡Œ */ }
  },

  // ============================================================
  //  æ—¥ä»˜å¤‰æ›´ã®è‡ªå‹•æ¤œçŸ¥ â†’ å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
  // ============================================================
  checkDateChange() {
    const today = new Date().toLocaleDateString('ja-JP');
    if (this.lastActiveDate && this.lastActiveDate !== today) {
      // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸ â†’ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»é€€å‹¤è“„ç©ãƒ»å£²ä¸Šã‚’ãƒªã‚»ãƒƒãƒˆ
      this.partners = [];
      this.retiredHours = 0;
      document.getElementById('mon-sales').value = '';
      document.getElementById('mon-open').value = '';
      document.getElementById('mon-close').value = '';
      console.log('[Labor Monitor] æ—¥ä»˜å¤‰æ›´æ¤œçŸ¥ â†’ å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ');
    }
    this.lastActiveDate = today;
    this.persist();
  },
};

// ============================================================
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ============================================================
function timeToMinutes(timeStr) {
  if (!timeStr) return null;
  const parts = timeStr.split(':');
  if (parts.length < 2) return null;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (isNaN(h) || isNaN(m)) return null;
  return h * 60 + m;
}

function nowMinutes() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}

function todayDateString() {
  return new Date().toLocaleDateString('ja-JP');
}

// ============================================================
//  æ™‚è¨ˆ
// ============================================================
function updateClock() {
  const now = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  document.getElementById('clock').textContent =
    pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('date-str').textContent =
    now.getFullYear() + '/' + pad(now.getMonth() + 1) + '/' + pad(now.getDate()) +
    ' (' + days[now.getDay()] + ')';
}

// ============================================================
//  ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ============================================================
function showTab(name) {
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === name);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  if (page) page.classList.add('active');
  if (name === 'history') renderHistory();
}

// ============================================================
//  ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
// ============================================================

/** éã‚ªãƒšæ™‚é–“ã®åˆè¨ˆï¼ˆåˆ†ï¼‰ */
function sumNonOpeMinutes(p) {
  return (p.breakMin || 0) + (p.meetingMin || 0) + (p.trainingMin || 0) +
         (p.experienceMin || 0) + (p.cleanlinessMin || 0) + (p.managementMin || 0);
}

/** å®Ÿã‚ªãƒšåŠ´åƒæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ */
function calcWorkedHours(p) {
  const startMin = timeToMinutes(p.start);
  if (startMin === null) return 0;
  const now = nowMinutes();
  // é€€ç¤¾äºˆå®šãŒã‚ã‚Šã‹ã¤ç¾åœ¨ãŒéãã¦ã„ã‚Œã°é€€ç¤¾æ™‚åˆ»ã§æ‰“ã¡æ­¢ã‚
  const endMin = timeToMinutes(p.end);
  const effectiveEnd = (endMin !== null && now > endMin) ? endMin : now;
  const elapsed = Math.max(0, effectiveEnd - startMin);
  const nonOpe = sumNonOpeMinutes(p);
  return Math.max(0, elapsed - nonOpe) / 60;
}

/** éã‚ªãƒšæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ */
function calcNonOpeHours(p) {
  return sumNonOpeMinutes(p) / 60;
}

/** å…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆé€€å‹¤æ¸ˆå«ã‚€ï¼‰ã®åˆè¨ˆã‚ªãƒšæ™‚é–“ */
function totalWorkedHours() {
  return App.retiredHours + App.partners.reduce((sum, p) => sum + calcWorkedHours(p), 0);
}

// ============================================================
//  ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¿½åŠ ãƒ»å‰Šé™¤
// ============================================================
function addPartner() {
  const nameEl = document.getElementById('add-name');
  const startEl = document.getElementById('add-start');
  const breakEl = document.getElementById('add-break');
  const endEl = document.getElementById('add-end');

  const name = nameEl.value.trim();
  const start = startEl.value;
  if (!name || !start) { alert('æ°åã¨å‡ºç¤¾æ™‚åˆ»ã¯å¿…é ˆã§ã™'); return; }

  const brk = Math.max(0, parseInt(breakEl.value) || 0);
  const end = endEl.value || '';

  App.partners.push({
    id: Date.now(),
    name,
    start,
    end,
    breakMin: brk,
    meetingMin: 0,
    trainingMin: 0,
    experienceMin: 0,
    cleanlinessMin: 0,
    managementMin: 0,
  });

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  nameEl.value = '';
  startEl.value = '';
  breakEl.value = '';
  endEl.value = '';

  App.persist();
  renderPartners();
  refreshMonitor();
  showTab('monitor');
}

function removePartner(id) {
  const p = App.partners.find(x => x.id === id);
  if (p) {
    App.retiredHours += calcWorkedHours(p);
  }
  App.partners = App.partners.filter(x => x.id !== id);
  App.persist();
  renderPartners();
  refreshMonitor();
}

function clearAllPartners() {
  if (!App.partners.length) { alert('å‡ºå‹¤ä¸­ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯ã„ã¾ã›ã‚“'); return; }
  if (!confirm(`å‡ºå‹¤ä¸­ã®å…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆ${App.partners.length}åï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  // å…¨å“¡ã®åŠ´åƒæ™‚é–“ã‚’é€€å‹¤æ¸ˆã«åŠ ç®—
  App.partners.forEach(p => { App.retiredHours += calcWorkedHours(p); });
  App.partners = [];
  App.persist();
  renderPartners();
  refreshMonitor();
}

// ============================================================
//  éã‚ªãƒšå…¥åŠ› inlineï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¡Œå†…ï¼‰
// ============================================================
function makeNonOpeInput(pid, field, label, val) {
  const v = val || 0;
  return `<label style="display:flex;align-items:center;gap:3px;font-size:0.68rem;color:var(--text-dim);">
    <span style="color:var(--gold);font-weight:700;">${label}</span>
    <input type="number" value="${v}"
      style="width:44px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:var(--font-mono);font-size:0.72rem;padding:2px 5px;text-align:center;"
      min="0" max="480" inputmode="numeric"
      onchange="updateNonOpe(${pid},'${field}',this.value)">åˆ†
  </label>`;
}

function updateNonOpe(id, field, val) {
  const p = App.partners.find(x => x.id === id);
  if (p) {
    p[field] = Math.max(0, parseInt(val) || 0);
    App.persist();
    refreshMonitor();
  }
}

// ============================================================
//  ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§æç”»
// ============================================================
function renderPartners() {
  const list = document.getElementById('partner-list');
  const empty = document.getElementById('partner-empty');
  const countEl = document.getElementById('partner-count');
  countEl.textContent = App.partners.length ? `(${App.partners.length}å)` : '';

  if (!App.partners.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    list.appendChild(empty);
    return;
  }

  empty.style.display = 'none';
  list.innerHTML = '';

  App.partners.forEach(p => {
    const wh = calcWorkedHours(p);
    const nonOpe = calcNonOpeHours(p);
    const whClass = wh >= 8 ? 'warn' : '';
    const row = document.createElement('div');
    row.className = 'partner-row';
    row.dataset.id = p.id;
    row.innerHTML = `
      <div class="partner-name">${escapeHtml(p.name)}</div>
      <div class="partner-info">
        <div class="pinfo">å‡ºç¤¾ <span>${p.start}</span></div>
        ${p.end ? `<div class="pinfo">é€€ç¤¾äºˆå®š <span>${p.end}</span></div>` : '<div class="pinfo" style="color:var(--text-dim)">é€€ç¤¾äºˆå®š æœªè¨­å®š</div>'}
        <div class="pinfo nonope-row" style="flex-basis:100%;margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;">
          ${makeNonOpeInput(p.id, 'breakMin', 'ä¼‘æ†©', p.breakMin)}
          ${makeNonOpeInput(p.id, 'meetingMin', 'MTG', p.meetingMin)}
          ${makeNonOpeInput(p.id, 'trainingMin', 'è‚²æˆ', p.trainingMin)}
          ${makeNonOpeInput(p.id, 'experienceMin', 'EXP', p.experienceMin)}
          ${makeNonOpeInput(p.id, 'cleanlinessMin', 'CLN', p.cleanlinessMin)}
          ${makeNonOpeInput(p.id, 'managementMin', 'MGT', p.managementMin)}
        </div>
      </div>
      <div class="partner-hours ${whClass}">
        <span style="font-family:var(--font-display);font-size:1.5rem;">${wh.toFixed(2)}h</span><br>
        <span style="font-size:0.6rem;color:var(--text-dim);">ã‚ªãƒš / éã‚ªãƒš ${nonOpe.toFixed(2)}h</span>
      </div>
      <button class="edit-btn" onclick="openEditModal(${p.id})">âœï¸</button>
      <button class="remove-btn" onclick="removePartner(${p.id})">é€€å‹¤</button>
    `;
    list.appendChild(row);
  });
}

/** ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¡Œã®æ•°å€¤ã ã‘æ›´æ–°ï¼ˆDOMå†æ§‹ç¯‰ãªã—ï¼é«˜é€Ÿï¼‰ */
function updatePartnerHoursOnly() {
  document.querySelectorAll('.partner-row').forEach(row => {
    const id = parseInt(row.dataset.id, 10);
    const p = App.partners.find(x => x.id === id);
    if (!p) return;
    const wh = calcWorkedHours(p);
    const nonOpe = calcNonOpeHours(p);
    const hoursEl = row.querySelector('.partner-hours');
    if (hoursEl) {
      const color = wh >= 8 ? 'var(--orange)' : 'var(--green-bright)';
      hoursEl.innerHTML =
        `<span style="font-family:var(--font-display);font-size:1.5rem;color:${color};">${wh.toFixed(2)}h</span><br>` +
        `<span style="font-size:0.6rem;color:var(--text-dim);">ã‚ªãƒš / éã‚ªãƒš ${nonOpe.toFixed(2)}h</span>`;
    }
  });
}

// ============================================================
//  å–¶æ¥­æ™‚é–“ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ============================================================
function getBizElapsedHours() {
  const openVal = document.getElementById('mon-open').value;
  if (!openVal) return null;
  const closeVal = document.getElementById('mon-close').value;
  const openMin = timeToMinutes(openVal);
  const now = nowMinutes();
  const closeMin = closeVal ? timeToMinutes(closeVal) : null;
  if (now < openMin) return 0;
  const effectiveNow = (closeMin !== null && now > closeMin) ? closeMin : now;
  return Math.max(0, (effectiveNow - openMin) / 60);
}

function updateBizElapsedDisplay() {
  const openVal = document.getElementById('mon-open').value;
  const closeVal = document.getElementById('mon-close').value;
  const elapsedEl = document.getElementById('biz-elapsed');
  const statusBar = document.getElementById('biz-status-bar');

  if (!openVal) {
    elapsedEl.textContent = '--h --m';
    statusBar.style.display = 'none';
    return;
  }

  const elapsed = getBizElapsedHours() || 0;
  const h = Math.floor(elapsed);
  const m = Math.round((elapsed - h) * 60);
  elapsedEl.textContent = `${h}h ${String(m).padStart(2, '0')}m`;

  const now = nowMinutes();
  const openMin = timeToMinutes(openVal);
  const closeMin = closeVal ? timeToMinutes(closeVal) : null;

  statusBar.style.display = 'flex';
  if (now < openMin) {
    statusBar.style.cssText += 'background:#1A2D3A;border:1.5px solid #2A5080;color:#7ABCD0;display:flex;';
    statusBar.innerHTML = 'â³ é–‹åº—å‰ã§ã™ â€” å–¶æ¥­é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™';
  } else if (closeMin && now >= closeMin) {
    statusBar.style.cssText += 'background:#1A1A2D;border:1.5px solid #3A3A7A;color:#9090D0;display:flex;';
    statusBar.innerHTML = `ğŸŒ™ å–¶æ¥­çµ‚äº† â€” æœ¬æ—¥ã®å–¶æ¥­æ™‚é–“: ${openVal} ã€œ ${closeVal}`;
  } else {
    statusBar.style.cssText += 'background:#0D2D1A;border:1.5px solid #1A6B3A;color:#5CE88A;display:flex;';
    const remainMin = closeMin ? closeMin - now : null;
    const remainStr = remainMin !== null
      ? ` â€” æ®‹ã‚Šç´„ ${Math.floor(remainMin / 60)}h${remainMin % 60}m`
      : '';
    statusBar.innerHTML = `ğŸŸ¢ å–¶æ¥­ä¸­ ${openVal}ã€œ${closeVal || '?'}${remainStr}`;
  }
}

function onBizTimeChange() {
  updateBizElapsedDisplay();
  refreshMonitor();
  App.persist();
}

// ============================================================
//  ãƒ¢ãƒ‹ã‚¿ãƒ¼æ›´æ–°ï¼ˆã‚³ã‚¢è¨ˆç®—ï¼‰
// ============================================================
function refreshMonitor() {
  const salesVal = parseFloat(document.getElementById('mon-sales').value) || 0;
  const guideVal = parseFloat(document.getElementById('mon-guide').value) || App.config.defaultGuide;
  const actual = totalWorkedHours();

  // ã‚¬ã‚¤ãƒ‰æ™‚é–“ = å£²ä¸Š Ã· ã‚¬ã‚¤ãƒ‰å˜ä¾¡
  const guideH = (guideVal > 0 && salesVal > 0) ? salesVal / guideVal : 0;
  const ratio = guideH > 0 ? (actual / guideH) * 100 : 0;
  const diff = actual - guideH;

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
  const rc = ratio >= App.config.dangerLine ? 'danger'
           : ratio >= App.config.warnLine   ? 'warn'
           : 'ok';

  // --- å€¤ã®è¡¨ç¤º ---
  document.getElementById('val-guide-h').textContent = guideH > 0 ? guideH.toFixed(2) : '--';
  document.getElementById('val-actual-h').textContent = actual.toFixed(2);
  document.getElementById('val-ratio').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '--%';

  const diffEl = document.getElementById('val-diff');
  diffEl.textContent = guideH > 0 ? (diff >= 0 ? '+' : '') + diff.toFixed(2) : '--';
  diffEl.className = 'metric-value ' + (diff > 0 ? 'danger' : 'ok');

  document.getElementById('val-headcount').textContent = App.partners.length;
  document.getElementById('val-retired-h').textContent = App.retiredHours.toFixed(2);

  // --- éã‚ªãƒšå†…è¨³é›†è¨ˆ ---
  const fields = [
    ['breakMin',       'nonope-break'],
    ['meetingMin',     'nonope-meeting'],
    ['trainingMin',    'nonope-training'],
    ['experienceMin',  'nonope-exp'],
    ['cleanlinessMin', 'nonope-cln'],
    ['managementMin',  'nonope-mgt'],
  ];
  fields.forEach(([key, elId]) => {
    const total = App.partners.reduce((s, p) => s + (p[key] || 0), 0) / 60;
    document.getElementById(elId).textContent = total.toFixed(1);
  });

  // --- ã‚«ãƒ¼ãƒ‰è‰² ---
  ['mc-ratio', 'mc-diff'].forEach(id => {
    document.getElementById(id).className = 'metric-card ' + rc;
  });
  document.getElementById('val-ratio').className = 'metric-value ' + rc;

  // --- ã‚²ãƒ¼ã‚¸ ---
  const gaugePct = Math.min(ratio / 150 * 100, 100);
  const gFill = document.getElementById('gauge-mon');
  const gColor = rc === 'danger' ? 'var(--red)' : rc === 'warn' ? 'var(--orange)' : 'var(--green-bright)';
  gFill.style.width = gaugePct + '%';
  gFill.style.background = gColor;
  document.getElementById('gauge-mon-label').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '';
  document.getElementById('gauge-text-mon').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '--';

  // --- åˆ¤å®šãƒãƒŠãƒ¼ ---
  let verdict = '';
  if (ratio > 0) {
    if (ratio < App.config.warnLine) {
      verdict = `<div class="verdict ok"><span class="verdict-icon">âœ…</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” é©æ­£ç¯„å›²å†…ã§ã™ã€‚åŠ´åƒæ™‚é–“ãŒã‚¬ã‚¤ãƒ‰ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚</div>`;
    } else if (ratio < App.config.dangerLine) {
      verdict = `<div class="verdict warn"><span class="verdict-icon">âš ï¸</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” æ³¨æ„ãƒ©ã‚¤ãƒ³è¶…éã€‚ç´„ ${Math.abs(diff).toFixed(1)} æ™‚é–“åˆ†ã®è¶…éã§ã™ã€‚ä¼‘æ†©èª¿æ•´ã‚„æ—©ä¸ŠãŒã‚Šã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</div>`;
    } else {
      verdict = `<div class="verdict danger"><span class="verdict-icon">ğŸ”´</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” å±é™ºãƒ©ã‚¤ãƒ³è¶…éï¼${Math.abs(diff).toFixed(1)} æ™‚é–“åˆ†ã®éå‰°åŠ´åƒã§ã™ã€‚æ—©æ€¥ãªäººå“¡èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚</div>`;
    }
  }
  document.getElementById('verdict-mon').innerHTML = verdict;
}

// ============================================================
//  ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
//  - æ¯ç§’: æ™‚è¨ˆ + å–¶æ¥­çµŒé + æ•°å€¤æ›´æ–°ï¼ˆè»½é‡DOMæ“ä½œã®ã¿ï¼‰
//  - Nç§’æ¯: ãƒ•ãƒ«å†æç”»ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§ã®DOMå†æ§‹ç¯‰ï¼‰
// ============================================================
function startTimers() {
  const intervalSec = App.config.intervalSec || 300;
  App._countdownSec = intervalSec;

  clearInterval(App._fullRefreshTimer);
  clearInterval(App._countdownTimer);

  // ãƒ•ãƒ«æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼
  App._fullRefreshTimer = setInterval(() => {
    App.checkDateChange();
    renderPartners();
    refreshMonitor();
    App.persist();
    App._countdownSec = intervalSec;
  }, intervalSec * 1000);

  // æ¯ç§’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆè»½é‡å‡¦ç†ã®ã¿ï¼‰
  App._countdownTimer = setInterval(() => {
    updateClock();
    updateBizElapsedDisplay();
    refreshMonitor();
    updatePartnerHoursOnly();

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
    App._countdownSec = Math.max(0, App._countdownSec - 1);
    const m = Math.floor(App._countdownSec / 60);
    const s = App._countdownSec % 60;
    document.getElementById('val-countdown').textContent =
      String(m) + ':' + String(s).padStart(2, '0');
  }, 1000);
}

// ============================================================
//  ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ / å±¥æ­´
// ============================================================
function saveSnapshot() {
  const sales = parseFloat(document.getElementById('mon-sales').value) || 0;
  const guide = parseFloat(document.getElementById('mon-guide').value) || App.config.defaultGuide;
  const actual = totalWorkedHours();
  const guideH = guide > 0 && sales > 0 ? sales / guide : 0;
  const ratio = guideH > 0 ? (actual / guideH) * 100 : 0;
  const now = new Date();

  const snap = {
    id: Date.now(),
    date: now.toLocaleDateString('ja-JP'),
    time: now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
    sales,
    guide,
    guideH: guideH.toFixed(2),
    actual: actual.toFixed(2),
    ratio: ratio.toFixed(1),
    headcount: App.partners.length,
    partnerNames: App.partners.map(p => p.name).join(', '),
  };

  App.history.unshift(snap);
  if (App.history.length > 200) App.history = App.history.slice(0, 200);
  App.persist();
  alert(`ä¿å­˜ã—ã¾ã—ãŸï¼\nã‚¬ã‚¤ãƒ‰æ¯”: ${ratio.toFixed(1)}%`);
}

function renderHistory() {
  const list = document.getElementById('history-list');
  const empty = document.getElementById('history-empty');
  if (!App.history.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    list.appendChild(empty);
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = '';

  // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  const grouped = {};
  App.history.forEach(h => {
    if (!grouped[h.date]) grouped[h.date] = [];
    grouped[h.date].push(h);
  });

  Object.entries(grouped).forEach(([date, entries]) => {
    const dateHeader = document.createElement('div');
    dateHeader.style.cssText = 'font-size:0.72rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin:16px 0 8px;padding:0 4px;';
    dateHeader.textContent = date;
    list.appendChild(dateHeader);

    entries.forEach(h => {
      const rc = parseFloat(h.ratio) >= App.config.dangerLine ? 'danger'
               : parseFloat(h.ratio) >= App.config.warnLine   ? 'warn'
               : 'ok';
      const el = document.createElement('div');
      el.className = 'history-entry';
      el.innerHTML = `
        <div class="hist-header">
          <div>
            <div class="hist-date">${escapeHtml(h.date)} ${escapeHtml(h.time)}</div>
            <div class="hist-guide">ã‚¬ã‚¤ãƒ‰å˜ä¾¡ Â¥${Number(h.guide || 0).toLocaleString()} ï¼ å‡ºå‹¤ ${h.headcount}å</div>
          </div>
          <button class="delete-hist" onclick="deleteHistory(${h.id})">âœ•</button>
        </div>
        <div class="hist-metrics">
          <div class="hist-metric"><div class="hist-val" style="color:var(--text)">Â¥${Number(h.sales || 0).toLocaleString()}</div><div class="hist-lbl">å£²ä¸Š</div></div>
          <div class="hist-metric"><div class="hist-val">${h.guideH}h</div><div class="hist-lbl">ã‚¬ã‚¤ãƒ‰æ™‚é–“</div></div>
          <div class="hist-metric"><div class="hist-val">${h.actual}h</div><div class="hist-lbl">å®ŸåŠ´åƒæ™‚é–“</div></div>
          <div class="hist-metric"><div class="hist-val ${rc}">${h.ratio}%</div><div class="hist-lbl">ã‚¬ã‚¤ãƒ‰æ¯”</div></div>
        </div>
        ${h.partnerNames ? `<div style="margin-top:8px;font-size:0.7rem;color:var(--text-dim);">å‡ºå‹¤: ${escapeHtml(h.partnerNames)}</div>` : ''}
      `;
      list.appendChild(el);
    });
  });
}

function deleteHistory(id) {
  App.history = App.history.filter(h => h.id !== id);
  App.persist();
  renderHistory();
}

// ============================================================
//  è¨­å®š
// ============================================================
function saveConfig() {
  App.config.store        = document.getElementById('cfg-store').value || '';
  App.config.defaultGuide = parseFloat(document.getElementById('cfg-guide').value) || 7665;
  App.config.warnLine     = parseFloat(document.getElementById('cfg-warn').value) || 105;
  App.config.dangerLine   = parseFloat(document.getElementById('cfg-danger').value) || 115;
  App.config.intervalSec  = parseInt(document.getElementById('cfg-interval').value, 10) || 300;
  updateStoreHeader();
  App.persist();
  startTimers(); // é–“éš”å¤‰æ›´ã‚’å³æ™‚åæ˜ 
  refreshMonitor();
}

function updateStoreHeader() {
  const tag = document.getElementById('hdr-store-tag');
  const banner = document.getElementById('store-setup-banner');
  if (App.config.store) {
    tag.textContent = App.config.store;
    tag.classList.add('visible');
    if (banner) banner.style.display = 'none';
  } else {
    tag.classList.remove('visible');
    if (banner) banner.style.display = 'block';
  }
}

// ============================================================
//  ãƒ‡ãƒ¼ã‚¿ç®¡ç†
// ============================================================
function exportData() {
  const rows = ['æ—¥ä»˜,æ™‚åˆ»,å£²ä¸Š,ã‚¬ã‚¤ãƒ‰å˜ä¾¡,ã‚¬ã‚¤ãƒ‰æ™‚é–“,å®ŸåŠ´åƒæ™‚é–“,ã‚¬ã‚¤ãƒ‰æ¯”(%),å‡ºå‹¤äººæ•°,ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'];
  App.history.forEach(h => {
    rows.push([h.date, h.time, h.sales, h.guide, h.guideH, h.actual, h.ratio, h.headcount, `"${(h.partnerNames || '').replace(/"/g, '""')}"`].join(','));
  });
  const blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'labor_monitor_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function clearToday() {
  if (!confirm('æœ¬æ—¥ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  App.partners = [];
  App.retiredHours = 0;
  document.getElementById('mon-sales').value = '';
  App.persist();
  renderPartners();
  refreshMonitor();
}

function clearAll() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå±¥æ­´å«ã‚€ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  App.partners = [];
  App.history = [];
  App.retiredHours = 0;
  App.persist();
  renderPartners();
  refreshMonitor();
  renderHistory();
}

// ============================================================
//  ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
// ============================================================
function openEditModal(id) {
  const p = App.partners.find(x => x.id === id);
  if (!p) return;
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-name').value = p.name;
  document.getElementById('edit-start').value = p.start;
  document.getElementById('edit-end').value = p.end || '';
  document.getElementById('edit-break').value = p.breakMin || 0;
  document.getElementById('edit-meeting').value = p.meetingMin || 0;
  document.getElementById('edit-training').value = p.trainingMin || 0;
  document.getElementById('edit-experience').value = p.experienceMin || 0;
  document.getElementById('edit-cleanliness').value = p.cleanlinessMin || 0;
  document.getElementById('edit-management').value = p.managementMin || 0;
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
}

function saveEdit() {
  const id = parseInt(document.getElementById('edit-id').value, 10);
  const name = document.getElementById('edit-name').value.trim();
  const start = document.getElementById('edit-start').value;
  if (!name || !start) { alert('æ°åã¨å‡ºç¤¾æ™‚åˆ»ã¯å¿…é ˆã§ã™'); return; }

  const p = App.partners.find(x => x.id === id);
  if (p) {
    p.name            = name;
    p.start           = start;
    p.end             = document.getElementById('edit-end').value || '';
    p.breakMin        = Math.max(0, parseInt(document.getElementById('edit-break').value) || 0);
    p.meetingMin      = Math.max(0, parseInt(document.getElementById('edit-meeting').value) || 0);
    p.trainingMin     = Math.max(0, parseInt(document.getElementById('edit-training').value) || 0);
    p.experienceMin   = Math.max(0, parseInt(document.getElementById('edit-experience').value) || 0);
    p.cleanlinessMin  = Math.max(0, parseInt(document.getElementById('edit-cleanliness').value) || 0);
    p.managementMin   = Math.max(0, parseInt(document.getElementById('edit-management').value) || 0);
    App.persist();
    renderPartners();
    refreshMonitor();
  }
  closeEditModal();
}

// ============================================================
//  XSSå¯¾ç­–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
function escapeHtml(str) {
  if (!str) return '';
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  return String(str).replace(/[&<>"']/g, c => map[c]);
}

// ============================================================
//  åˆæœŸåŒ–
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  App.load();
  App.checkDateChange();

  // UIã«è¨­å®šã‚’åæ˜ 
  document.getElementById('cfg-store').value    = App.config.store;
  document.getElementById('cfg-guide').value    = App.config.defaultGuide;
  document.getElementById('cfg-warn').value     = App.config.warnLine;
  document.getElementById('cfg-danger').value   = App.config.dangerLine;
  document.getElementById('cfg-interval').value = App.config.intervalSec;
  document.getElementById('mon-guide').value    = App.config.defaultGuide;

  // å‰å›ã®å–¶æ¥­æ™‚é–“ãƒ»å£²ä¸Šã‚’å¾©å…ƒï¼ˆåŒæ—¥ã®ã¿ï¼‰
  const sk = App.STORAGE_KEYS;
  const savedOpen  = localStorage.getItem(sk.bizOpen) || '';
  const savedClose = localStorage.getItem(sk.bizClose) || '';
  const savedSales = localStorage.getItem(sk.sales) || '';
  document.getElementById('mon-open').value  = savedOpen;
  document.getElementById('mon-close').value = savedClose;
  document.getElementById('mon-sales').value = savedSales;

  updateStoreHeader();
  updateClock();
  renderPartners();
  updateBizElapsedDisplay();
  refreshMonitor();
  startTimers();

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
  document.getElementById('edit-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
  });
});
</script>

</body>
</html>
