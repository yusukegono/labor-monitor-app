<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Labor Monitor â€” SBCJ</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0D1F1A;
  --surface: #132B23;
  --surface2: #1A3B2F;
  --green: #00A862;
  --green-bright: #00D97E;
  --gold: #F0C040;
  --red: #FF4D4D;
  --orange: #FF9020;
  --text: #E8F5EE;
  --text-dim: #7AB898;
  --border: #254D3A;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; background:var(--bg); color:var(--text); font-family:'Noto Sans JP',sans-serif; overflow-x:hidden; }

/* ===== HEADER ===== */
.header {
background: linear-gradient(135deg, #0A1A15 0%, #132B23 100%);
border-bottom: 1px solid var(â€“border);
padding: 16px 20px 12px;
display: flex; align-items: center; justify-content: space-between;
position: sticky; top:0; z-index:100;
}
.header-left { display:flex; align-items:center; gap:12px; }
.sblogo { width:40px; height:40px; background:var(â€“green); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.sblogo svg { width:24px; height:24px; }
.store-name { font-size:1rem; font-weight:700; letter-spacing:0.05em; }
.store-sub { font-size:0.65rem; color:var(â€“text-dim); margin-top:1px; }
.clock-box { text-align:right; }
.clock { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:2rem; color:var(â€“green-bright); letter-spacing:0.05em; line-height:1; }
.date-str { font-size:0.65rem; color:var(â€“text-dim); }

/* ===== TABS ===== */
.tabs { display:flex; background:var(â€“surface); border-bottom:1px solid var(â€“border); }
.tab { flex:1; padding:12px 8px; text-align:center; font-size:0.75rem; font-weight:500; color:var(â€“text-dim); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; }
.tab.active { color:var(â€“green-bright); border-bottom-color:var(â€“green-bright); background:var(â€“surface2); }

/* ===== MAIN ===== */
.page { display:none; padding:16px; max-width:900px; margin:0 auto; }
.page.active { display:block; }

/* ===== SETUP CARD ===== */
.card { background:var(â€“surface); border:1px solid var(â€“border); border-radius:14px; padding:18px; margin-bottom:14px; }
.card-title { font-size:0.65rem; font-weight:700; letter-spacing:0.15em; text-transform:uppercase; color:var(â€“green); margin-bottom:14px; }
.row2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.field label { display:block; font-size:0.72rem; color:var(â€“text-dim); margin-bottom:5px; }
.field input, .field select {
width:100%; background:var(â€“bg); border:1.5px solid var(â€“border); border-radius:8px;
color:var(â€“text); font-family:â€˜DM Monoâ€™,monospace; font-size:0.9rem;
padding:10px 12px; outline:none; transition:border-color 0.2s;
-webkit-appearance:none;
}
.field input:focus, .field select:focus { border-color:var(â€“green); }
.field select option { background:var(â€“bg); }

/* ===== BIG METRICS ===== */
.metrics-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px; }
.metric-card {
background:var(â€“surface); border:1px solid var(â€“border); border-radius:14px;
padding:16px; text-align:center; position:relative; overflow:hidden;
}
.metric-card::before {
content:â€™â€™; position:absolute; top:0; left:0; right:0; height:3px;
background:var(â€“green);
}
.metric-card.warn::before { background:var(â€“orange); }
.metric-card.danger::before { background:var(â€“red); }
.metric-card.ok::before { background:var(â€“green-bright); }
.metric-label { font-size:0.62rem; letter-spacing:0.12em; text-transform:uppercase; color:var(â€“text-dim); margin-bottom:6px; }
.metric-value { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:2.8rem; line-height:1; color:var(â€“green-bright); }
.metric-value.warn { color:var(â€“orange); }
.metric-value.danger { color:var(â€“red); }
.metric-unit { font-size:0.7rem; color:var(â€“text-dim); margin-top:3px; }

/* ===== GAUGE ===== */
.gauge-wrap { margin-bottom:14px; }
.gauge-header { display:flex; justify-content:space-between; font-size:0.72rem; color:var(â€“text-dim); margin-bottom:6px; }
.gauge-track { background:var(â€“surface2); border-radius:20px; height:28px; overflow:hidden; position:relative; border:1px solid var(â€“border); }
.gauge-fill {
height:100%; border-radius:20px; display:flex; align-items:center; justify-content:flex-end;
padding-right:12px; transition:width 0.8s cubic-bezier(0.34,1.2,0.64,1), background 0.5s;
min-width:2px;
}
.gauge-fill span { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:1rem; color:white; }
.gauge-ticks { display:flex; justify-content:space-between; margin-top:4px; }
.gauge-tick { font-family:â€˜DM Monoâ€™,monospace; font-size:0.6rem; color:var(â€“text-dim); }

/* ===== PARTNER TABLE ===== */
.partner-list { display:flex; flex-direction:column; gap:8px; }
.partner-row {
background:var(â€“surface); border:1px solid var(â€“border); border-radius:10px;
padding:12px 14px; display:flex; align-items:center; gap:10px;
}
.partner-name { font-weight:500; font-size:0.88rem; min-width:80px; flex-shrink:0; }
.partner-info { flex:1; display:flex; gap:8px; flex-wrap:wrap; }
.pinfo { font-family:â€˜DM Monoâ€™,monospace; font-size:0.75rem; color:var(â€“text-dim); }
.pinfo span { color:var(â€“text); }
.partner-hours { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:1.5rem; color:var(â€“green-bright); min-width:52px; text-align:right; }
.partner-hours.warn { color:var(â€“orange); }
.remove-btn { background:none; border:1px solid var(â€“border); border-radius:6px; color:var(â€“text-dim); padding:4px 8px; cursor:pointer; font-size:0.7rem; }
.remove-btn:hover { border-color:var(â€“red); color:var(â€“red); }

/* ===== ADD PARTNER FORM ===== */
.add-form { background:var(â€“surface2); border:1px dashed var(â€“border); border-radius:12px; padding:14px; margin-bottom:14px; }
.add-form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }

/* ===== BUTTONS ===== */
.btn {
border:none; border-radius:10px; padding:12px 18px;
font-family:â€˜Noto Sans JPâ€™,sans-serif; font-size:0.85rem; font-weight:700;
cursor:pointer; transition:all 0.15s; letter-spacing:0.05em;
}
.btn-primary { background:var(â€“green); color:white; width:100%; }
.btn-primary:hover { background:var(â€“green-bright); }
.btn-small { background:var(â€“surface2); color:var(â€“text); border:1px solid var(â€“border); padding:8px 14px; font-size:0.78rem; }
.btn-small:hover { border-color:var(â€“green); color:var(â€“green-bright); }
.btn-danger { background:transparent; color:var(â€“red); border:1px solid var(â€“red); }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; }

/* ===== HISTORY ===== */
.history-entry {
background:var(â€“surface); border:1px solid var(â€“border); border-radius:12px;
padding:14px; margin-bottom:10px;
}
.hist-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.hist-date { font-weight:700; font-size:0.9rem; }
.hist-guide { font-family:â€˜DM Monoâ€™,monospace; font-size:0.72rem; color:var(â€“text-dim); }
.hist-metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
.hist-metric { text-align:center; }
.hist-val { font-family:â€˜Bebas Neueâ€™,sans-serif; font-size:1.4rem; }
.hist-val.ok { color:var(â€“green-bright); }
.hist-val.warn { color:var(â€“orange); }
.hist-val.danger { color:var(â€“red); }
.hist-lbl { font-size:0.6rem; color:var(â€“text-dim); }
.delete-hist { background:none; border:none; color:var(â€“text-dim); cursor:pointer; font-size:0.8rem; padding:4px 8px; }
.delete-hist:hover { color:var(â€“red); }

/* ===== VERDICT BANNER ===== */
.verdict {
border-radius:12px; padding:14px 16px; margin-bottom:14px;
font-size:0.88rem; font-weight:500; display:flex; gap:10px; align-items:flex-start;
border:1.5px solid;
}
.verdict.ok { background:#0D2D1A; border-color:#1A6B3A; color:#5CE88A; }
.verdict.warn { background:#2D1E00; border-color:#7A5000; color:#FFB020; }
.verdict.danger { background:#2D0D0D; border-color:#7A2020; color:#FF6060; }
.verdict-icon { font-size:1.3rem; flex-shrink:0; margin-top:-2px; }

/* ===== SAVE SNAPSHOT BTN ===== */
.save-btn { background:var(â€“gold); color:#1A1000; font-weight:700; border:none; border-radius:10px; padding:13px; width:100%; font-size:0.9rem; cursor:pointer; margin-top:4px; transition:opacity 0.2s; }
.save-btn:hover { opacity:0.88; }

/* ===== UPDATE BADGE ===== */
.live-badge { display:inline-flex; align-items:center; gap:5px; font-size:0.65rem; color:var(â€“green-bright); background:rgba(0,216,126,0.12); border:1px solid rgba(0,216,126,0.3); border-radius:20px; padding:3px 10px; }
.live-dot { width:6px; height:6px; background:var(â€“green-bright); border-radius:50%; animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

/* ===== EMPTY STATE ===== */
.empty { text-align:center; color:var(â€“text-dim); padding:40px 20px; font-size:0.85rem; }

/* ===== EDIT MODAL ===== */
.modal-overlay {
display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75);
z-index:200; align-items:center; justify-content:center; padding:20px;
}
.modal-overlay.open { display:flex; }
.modal {
background:var(â€“surface); border:1px solid var(â€“border); border-radius:16px;
padding:24px; width:100%; max-width:420px;
animation: slideUp 0.2s ease;
}
@keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
.modal-title { font-size:0.88rem; font-weight:700; color:var(â€“green-bright); margin-bottom:18px; letter-spacing:0.05em; }
.modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
.modal-actions { display:flex; gap:10px; }
.btn-save { background:var(â€“green); color:white; border:none; border-radius:10px; padding:12px; flex:1; font-size:0.88rem; font-weight:700; cursor:pointer; font-family:â€˜Noto Sans JPâ€™,sans-serif; }
.btn-save:hover { background:var(â€“green-bright); }
.btn-cancel { background:var(â€“surface2); color:var(â€“text-dim); border:1px solid var(â€“border); border-radius:10px; padding:12px; flex:1; font-size:0.88rem; cursor:pointer; font-family:â€˜Noto Sans JPâ€™,sans-serif; }
.edit-btn { background:none; border:1px solid var(â€“green); border-radius:6px; color:var(â€“green); padding:4px 8px; cursor:pointer; font-size:0.7rem; flex-shrink:0; }
.edit-btn:hover { background:var(â€“green); color:white; }

/* ===== EDIT MODAL ===== */
.modal-overlay {
display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
z-index:200; align-items:center; justify-content:center; padding:20px;
}
.modal-overlay.open { display:flex; }
.modal {
background:var(â€“surface); border:1px solid var(â€“border); border-radius:16px;
padding:24px; width:100%; max-width:420px;
animation: slideUp 0.2s ease;
}
@keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
.modal-title { font-size:0.85rem; font-weight:700; color:var(â€“green-bright); margin-bottom:18px; letter-spacing:0.05em; }
.modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
.modal-actions { display:flex; gap:10px; }
.btn-save { background:var(â€“green); color:white; border:none; border-radius:10px; padding:12px; flex:1; font-size:0.88rem; font-weight:700; cursor:pointer; font-family:â€˜Noto Sans JPâ€™,sans-serif; }
.btn-cancel { background:var(â€“surface2); color:var(â€“text-dim); border:1px solid var(â€“border); border-radius:10px; padding:12px; flex:1; font-size:0.88rem; cursor:pointer; font-family:â€˜Noto Sans JPâ€™,sans-serif; }
.edit-btn { background:none; border:1px solid var(â€“border); border-radius:6px; color:var(â€“green); padding:4px 8px; cursor:pointer; font-size:0.7rem; }
.edit-btn:hover { border-color:var(â€“green-bright); }

/* ===== RESPONSIVE ===== */
@media (max-width: 500px) {
.metrics-grid { grid-template-columns:1fr 1fr; }
.row3 { grid-template-columns:1fr 1fr; }
.hist-metrics { grid-template-columns:repeat(2,1fr); }
.metric-value { font-size:2.2rem; }
}
</style>

</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="sblogo">
      <svg viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" fill="white" opacity="0.15"/>
        <path d="M12 4C8.13 4 5 7.13 5 11c0 2.76 1.57 5.16 3.88 6.38L8.5 20h7l-.38-2.62C17.43 16.16 19 13.76 19 11c0-3.87-3.13-7-7-7z" fill="white" opacity="0.9"/>
        <ellipse cx="12" cy="10.5" rx="3" ry="3.5" fill="#00A862"/>
      </svg>
    </div>
    <div>
      <div class="store-name" id="hdr-store">625 æˆåŸåº—</div>
      <div class="store-sub">Labor Monitor <span class="live-badge"><span class="live-dot"></span>LIVE</span></div>
    </div>
  </div>
  <div class="clock-box">
    <div class="clock" id="clock">--:--:--</div>
    <div class="date-str" id="date-str">----/--/--</div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('monitor')">ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒ¼</div>
  <div class="tab" onclick="showTab('partners')">ğŸ‘¥ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
  <div class="tab" onclick="showTab('setup')">âš™ï¸ è¨­å®š</div>
  <div class="tab" onclick="showTab('history')">ğŸ“… å±¥æ­´</div>
</div>

<!-- ========== MONITOR PAGE ========== -->

<div class="page active" id="page-monitor">

  <!-- å–¶æ¥­æ™‚é–“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->

  <div id="biz-status-bar" style="border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:0.82rem;font-weight:500;align-items:center;gap:8px;display:none;"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
    <div class="field">
      <label>ğŸ• å–¶æ¥­é–‹å§‹</label>
      <input type="time" id="mon-open" oninput="onBizTimeChange()">
    </div>
    <div class="field">
      <label>ğŸ•™ å–¶æ¥­çµ‚äº†</label>
      <input type="time" id="mon-close" oninput="onBizTimeChange()">
    </div>
    <div class="field">
      <label>çµŒéæ™‚é–“</label>
      <div id="biz-elapsed" style="background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-family:'DM Mono',monospace;font-size:0.9rem;color:var(--green-bright);">--h --m</div>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
    <div class="field" style="flex:1;min-width:140px;">
      <label>ç¾åœ¨ã®å£²ä¸Š (å††)</label>
      <input type="number" id="mon-sales" placeholder="552042" inputmode="numeric" oninput="refreshMonitor()">
    </div>
    <div class="field" style="flex:1;min-width:120px;">
      <label>ã‚¬ã‚¤ãƒ‰å˜ä¾¡ (å††/h)</label>
      <input type="number" id="mon-guide" placeholder="7665" inputmode="numeric" oninput="refreshMonitor()">
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card" id="mc-guide">
      <div class="metric-label">ã‚¬ã‚¤ãƒ‰æ™‚é–“ï¼ˆé©æ­£ã‚ªãƒšæ™‚é–“ï¼‰</div>
      <div class="metric-value" id="val-guide-h">--</div>
      <div class="metric-unit">æ™‚é–“</div>
    </div>
    <div class="metric-card" id="mc-actual">
      <div class="metric-label">å®Ÿã‚ªãƒšæ™‚é–“ï¼ˆéã‚ªãƒšé™¤å¤–æ¸ˆï¼‰</div>
      <div class="metric-value" id="val-actual-h">0.0</div>
      <div class="metric-unit">æ™‚é–“</div>
    </div>
    <div class="metric-card" id="mc-ratio">
      <div class="metric-label">ã‚¬ã‚¤ãƒ‰æ¯”</div>
      <div class="metric-value" id="val-ratio">--%</div>
      <div class="metric-unit">å®ŸåŠ´åƒ Ã· ã‚¬ã‚¤ãƒ‰</div>
    </div>
    <div class="metric-card" id="mc-diff">
      <div class="metric-label">éä¸è¶³æ™‚é–“</div>
      <div class="metric-value" id="val-diff">--</div>
      <div class="metric-unit">æ™‚é–“ï¼ˆï¼‹è¶…é ï¼ âˆ’ä½™å‰°ï¼‰</div>
    </div>
    <div class="metric-card" style="grid-column:1/-1;background:var(--surface2);">
      <div class="metric-label" style="margin-bottom:10px;">éã‚ªãƒšæ™‚é–“å†…è¨³ â€” ã‚¬ã‚¤ãƒ‰æ¯”è¨ˆç®—ã‹ã‚‰é™¤å¤–æ¸ˆã¿ âœ“</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;text-align:center;">
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-break">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">ä¼‘æ†©(h)</div></div>
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-meeting">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">MTG(h)</div></div>
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-training">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">è‚²æˆ(h)</div></div>
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-exp">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">EXP(h)</div></div>
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-cln">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">CLN(h)</div></div>
        <div><div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);" id="nonope-mgt">0.0</div><div style="font-size:0.6rem;color:var(--text-dim);">MGT(h)</div></div>
      </div>
    </div>
  </div>

  <div class="gauge-wrap">
    <div class="gauge-header">
      <span>ã‚¬ã‚¤ãƒ‰æ¯”ã‚²ãƒ¼ã‚¸</span>
      <span id="gauge-text-mon">--</span>
    </div>
    <div class="gauge-track">
      <div class="gauge-fill" id="gauge-mon" style="width:0%;background:var(--green)">
        <span id="gauge-mon-label"></span>
      </div>
    </div>
    <div class="gauge-ticks">
      <span class="gauge-tick">0%</span>
      <span class="gauge-tick">50%</span>
      <span class="gauge-tick" style="color:var(--green-bright);">100%</span>
      <span class="gauge-tick" style="color:var(--orange);">120%</span>
      <span class="gauge-tick" style="color:var(--red);">150%</span>
    </div>
  </div>

  <div id="verdict-mon"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
    <div class="card" style="margin:0;">
      <div class="metric-label" style="margin-bottom:4px;">å‡ºå‹¤äººæ•°ï¼ˆé€€å‹¤æ¸ˆå«ï¼‰</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold);" id="val-headcount">0</div>
      <div class="metric-unit">å <span style="font-size:0.65rem;color:var(--text-dim);">é€€å‹¤æ¸ˆ <span id="val-retired-h">0.0</span>h åŠ ç®—ä¸­</span></div>
    </div>
    <div class="card" style="margin:0;">
      <div class="metric-label" style="margin-bottom:4px;">æ¬¡å›æ›´æ–°ã¾ã§</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--text-dim);" id="val-countdown">5:00</div>
      <div class="metric-unit">è‡ªå‹•æ›´æ–° (5åˆ†æ¯)</div>
    </div>
  </div>

<button class="save-btn" onclick="saveSnapshot()">ğŸ“¸ ã“ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>

</div>

<!-- ========== PARTNERS PAGE ========== -->

<div class="page" id="page-partners">

  <div class="add-form">
    <div class="card-title">ï¼‹ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¿½åŠ </div>
    <div class="add-form-grid">
      <div class="field">
        <label>æ°å</label>
        <input type="text" id="add-name" placeholder="å±±ç”° èŠ±å­">
      </div>
      <div class="field">
        <label>å‡ºç¤¾æ™‚åˆ»</label>
        <input type="time" id="add-start">
      </div>
      <div class="field">
        <label>ç¾åœ¨ã¾ã§ã®ä¼‘æ†© (åˆ†)</label>
        <input type="number" id="add-break" placeholder="0" inputmode="numeric" min="0" max="480">
      </div>
      <div class="field">
        <label>é€€ç¤¾äºˆå®šæ™‚åˆ»</label>
        <input type="time" id="add-end" placeholder="ä»»æ„">
      </div>
    </div>
    <button class="btn btn-primary" onclick="addPartner()">è¿½åŠ ã™ã‚‹</button>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:0 4px;">
    <div class="card-title" style="margin:0;">å‡ºå‹¤ä¸­ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ <span id="partner-count" style="color:var(--gold);"></span></div>
    <button onclick="clearAllPartners()" style="background:#2D0D0D;border:1.5px solid var(--red);color:var(--red);border-radius:8px;padding:7px 14px;font-size:0.78rem;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;">ğŸ—‘ å…¨å“¡å‰Šé™¤</button>
  </div>
  <div class="partner-list" id="partner-list">
    <div class="empty" id="partner-empty">ã¾ã èª°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
  </div>
</div>

<!-- ========== SETUP PAGE ========== -->

<div class="page" id="page-setup">
  <div class="card">
    <div class="card-title">åº—èˆ—è¨­å®š</div>
    <div class="row2">
      <div class="field">
        <label>åº—èˆ—å</label>
        <input type="text" id="cfg-store" value="625 æˆåŸåº—" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¬ã‚¤ãƒ‰å˜ä¾¡ (å††/h)</label>
        <input type="number" id="cfg-guide" value="7665" inputmode="numeric" oninput="saveConfig()">
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</div>
    <div class="row3">
      <div class="field">
        <label>æ³¨æ„ãƒ©ã‚¤ãƒ³ (%)</label>
        <input type="number" id="cfg-warn" value="105" inputmode="numeric" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>å±é™ºãƒ©ã‚¤ãƒ³ (%)</label>
        <input type="number" id="cfg-danger" value="115" inputmode="numeric" oninput="saveConfig()">
      </div>
      <div class="field">
        <label>è‡ªå‹•æ›´æ–°é–“éš” (ç§’)</label>
        <input type="number" id="cfg-interval" value="300" inputmode="numeric" oninput="saveConfig()">
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div class="btn-row">
      <button class="btn btn-small" onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn btn-small" onclick="clearToday()">ğŸ”„ æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn btn-danger btn-small" onclick="clearAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- ========== HISTORY PAGE ========== -->

<div class="page" id="page-history">
  <div id="history-list">
    <div class="empty" id="history-empty">ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </div>
</div>

<script>
// ============================================================
//  STATE
// ============================================================
let partners = [];
let history = [];
let config = {
  store: '625 æˆåŸåº—',
  defaultGuide: 7665,
  warnLine: 105,
  dangerLine: 115,
  intervalSec: 300,
};
// å½“æ—¥ã®å–¶æ¥­æ™‚é–“ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆãˆã‚‹ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ï¼‰
let todayBizOpen = '';
let todayBizClose = '';
// é€€å‹¤æ¸ˆã¿ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ç¢ºå®šåŠ´åƒæ™‚é–“ã‚’è“„ç©
let retiredHours = 0;
let countdownSec = 300;
let autoTimer = null;
let countdownTimer = null;

// ============================================================
//  STORAGE
// ============================================================
function persist() {
  try {
    localStorage.setItem('sbcj_partners', JSON.stringify(partners));
    localStorage.setItem('sbcj_history', JSON.stringify(history));
    localStorage.setItem('sbcj_config', JSON.stringify(config));
    localStorage.setItem('sbcj_retiredHours', retiredHours);
  } catch(e) {}
}
function load() {
  try {
    const p = localStorage.getItem('sbcj_partners');
    const h = localStorage.getItem('sbcj_history');
    const c = localStorage.getItem('sbcj_config');
    if (p) partners = JSON.parse(p);
    if (h) history = JSON.parse(h);
    if (c) config = {...config, ...JSON.parse(c)};
    const r = localStorage.getItem('sbcj_retiredHours');
    if (r) retiredHours = parseFloat(r) || 0;
  } catch(e) {}
}

// ============================================================
//  CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0') + ':' +
    String(now.getSeconds()).padStart(2,'0');
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('date-str').textContent =
    now.getFullYear() + '/' +
    String(now.getMonth()+1).padStart(2,'0') + '/' +
    String(now.getDate()).padStart(2,'0') + ' (' + days[now.getDay()] + ')';
}

// ============================================================
//  TABS
// ============================================================
function showTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['monitor','partners','setup','history'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if (name === 'history') renderHistory();
}

// ============================================================
//  PARTNER LOGIC
// ============================================================
function timeToMinutes(timeStr) {
  if (!timeStr) return null;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}
function nowMinutes() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}
function calcWorkedHours(p) {
  const start = timeToMinutes(p.start);
  if (start === null) return 0;
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const elapsed = Math.max(0, nowMin - start);
  // å…¨éã‚ªãƒšæ™‚é–“ï¼ˆä¼‘æ†©ï¼‹ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‹è‚²æˆï¼‹ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ï¼‹ã‚¯ãƒ¬ãƒªãƒã‚¹ï¼‰ã‚’é™¤å¤–
  const nonOpe = (p.breakMin || 0) + (p.meetingMin || 0) + (p.trainingMin || 0) + (p.experienceMin || 0) + (p.cleanlinessMin || 0) + (p.managementMin || 0);
  return Math.max(0, elapsed - nonOpe) / 60;
}
function calcNonOpeHours(p) {
  return ((p.breakMin || 0) + (p.meetingMin || 0) + (p.trainingMin || 0) + (p.experienceMin || 0) + (p.cleanlinessMin || 0) + (p.managementMin || 0)) / 60;
}
function totalWorkedHours() {
  return retiredHours + partners.reduce((sum, p) => sum + calcWorkedHours(p), 0);
}

function addPartner() {
  const name = document.getElementById('add-name').value.trim();
  const start = document.getElementById('add-start').value;
  const brk = parseInt(document.getElementById('add-break').value) || 0;
  const end = document.getElementById('add-end').value;
  if (!name || !start) { alert('æ°åã¨å‡ºç¤¾æ™‚åˆ»ã¯å¿…é ˆã§ã™'); return; }
  const id = Date.now();
  partners.push({ id, name, start, breakMin: brk, end });
  document.getElementById('add-name').value = '';
  document.getElementById('add-start').value = '';
  document.getElementById('add-break').value = '';
  document.getElementById('add-end').value = '';
  persist();
  renderPartners();
  updateBizElapsedDisplay();
  refreshMonitor();
  showTab('monitor'); // ç™»éŒ²å¾Œã™ããƒ¢ãƒ‹ã‚¿ãƒ¼ç”»é¢ã«æˆ»ã‚‹
}

function makeNonOpeInput(pid, field, label, val) {
  const v = val || 0;
  return `<label style="display:flex;align-items:center;gap:3px;font-size:0.68rem;color:var(--text-dim);">
    <span style="color:var(--gold);font-weight:700;">${label}</span>
    <input type="number" value="${v}"
      style="width:44px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:2px 5px;text-align:center;"
      min="0" max="480" inputmode="numeric"
      onchange="updateNonOpe(${pid},'${field}',this.value)">åˆ†
  </label>`;
}
function updateNonOpe(id, field, val) {
  const p = partners.find(x => x.id === id);
  if (p) { p[field] = parseInt(val) || 0; persist(); refreshMonitor(); }
}
function updateBreak(id, val) {
  const p = partners.find(x => x.id === id);
  if (p) { p.breakMin = parseInt(val) || 0; persist(); refreshMonitor(); }
}

function clearAllPartners() {
  if (!partners.length) { alert('å‡ºå‹¤ä¸­ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯ã„ã¾ã›ã‚“'); return; }
  if (!confirm(`å‡ºå‹¤ä¸­ã®å…¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆ${partners.length}åï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  partners = [];
  persist();
  renderPartners();
  refreshMonitor();
}

function removePartner(id) {
  const p = partners.find(x => x.id === id);
  if (p) {
    // é€€å‹¤æ™‚ç‚¹ã®åŠ´åƒæ™‚é–“ã‚’ç¢ºå®šã—ã¦è“„ç©
    retiredHours += calcWorkedHours(p);
  }
  partners = partners.filter(x => x.id !== id);
  persist();
  renderPartners();
  refreshMonitor();
}

function renderPartners() {
  const list = document.getElementById('partner-list');
  const empty = document.getElementById('partner-empty');
  document.getElementById('partner-count').textContent = partners.length ? `(${partners.length}å)` : '';
  if (!partners.length) { empty.style.display='block'; list.innerHTML=''; list.appendChild(empty); return; }
  empty.style.display='none';
  list.innerHTML = '';
  partners.forEach(p => {
    const wh = calcWorkedHours(p);
    const wClass = wh >= 8 ? 'warn' : '';
    const row = document.createElement('div');
    row.className = 'partner-row';
    row.dataset.id = p.id;
    row.innerHTML = `
      <div class="partner-name">${p.name}</div>
      <div class="partner-info">
        <div class="pinfo">å‡ºç¤¾ <span>${p.start}</span></div>
        ${p.end ? `<div class="pinfo">é€€ç¤¾äºˆå®š <span>${p.end}</span></div>` : '<div class="pinfo" style="color:var(--text-dim)">é€€ç¤¾äºˆå®š æœªè¨­å®š</div>'}
        <div class="pinfo nonope-row" style="flex-basis:100%;margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;">
          ${makeNonOpeInput(p.id, 'breakMin', 'ä¼‘æ†©', p.breakMin)}
          ${makeNonOpeInput(p.id, 'meetingMin', 'MTG', p.meetingMin)}
          ${makeNonOpeInput(p.id, 'trainingMin', 'è‚²æˆ', p.trainingMin)}
          ${makeNonOpeInput(p.id, 'experienceMin', 'EXP', p.experienceMin)}
          ${makeNonOpeInput(p.id, 'cleanlinessMin', 'CLN', p.cleanlinessMin)}
          ${makeNonOpeInput(p.id, 'managementMin', 'MGT', p.managementMin)}
        </div>
      </div>
      <div class="partner-hours ${wClass}">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;">${wh.toFixed(2)}h</span><br>
        <span style="font-size:0.6rem;color:var(--text-dim);">ã‚ªãƒš / éã‚ªãƒš ${calcNonOpeHours(p).toFixed(2)}h</span>
      </div>
      <button class="edit-btn" onclick="openEditModal(${p.id})">âœï¸ ç·¨é›†</button>
      <button class="remove-btn" onclick="removePartner(${p.id})">é€€å‹¤</button>
    `;
    list.appendChild(row);
  });
}

// ============================================================
//  BUSINESS TIME HELPERS
// ============================================================
function getBizElapsedHours() {
  const openVal = document.getElementById('mon-open').value;
  const closeVal = document.getElementById('mon-close').value;
  if (!openVal) return null;
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const openMin = timeToMinutes(openVal);
  const closeMin = closeVal ? timeToMinutes(closeVal) : null;

  if (nowMin < openMin) return 0; // ã¾ã é–‹åº—å‰
  const effectiveNow = (closeMin && nowMin > closeMin) ? closeMin : nowMin;
  return Math.max(0, (effectiveNow - openMin) / 60);
}

function updateBizElapsedDisplay() {
  const openVal = document.getElementById('mon-open').value;
  const closeVal = document.getElementById('mon-close').value;
  const elapsedEl = document.getElementById('biz-elapsed');
  const statusBar = document.getElementById('biz-status-bar');

  if (!openVal) {
    elapsedEl.textContent = '--h --m';
    statusBar.style.display = 'none';
    return;
  }

  const elapsed = getBizElapsedHours();
  const h = Math.floor(elapsed);
  const m = Math.round((elapsed - h) * 60);
  elapsedEl.textContent = `${h}h ${String(m).padStart(2,'0')}m`;

  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const openMin = timeToMinutes(openVal);
  const closeMin = closeVal ? timeToMinutes(closeVal) : null;

  statusBar.style.display = 'flex';
  if (nowMin < openMin) {
    statusBar.style.background = '#1A2D3A';
    statusBar.style.border = '1.5px solid #2A5080';
    statusBar.style.color = '#7ABCD0';
    statusBar.innerHTML = 'â³ é–‹åº—å‰ã§ã™ â€” å–¶æ¥­é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™';
  } else if (closeMin && nowMin >= closeMin) {
    statusBar.style.background = '#1A1A2D';
    statusBar.style.border = '1.5px solid #3A3A7A';
    statusBar.style.color = '#9090D0';
    statusBar.innerHTML = `ğŸŒ™ å–¶æ¥­çµ‚äº† â€” æœ¬æ—¥ã®å–¶æ¥­æ™‚é–“: ${openVal} ã€œ ${closeVal}`;
  } else {
    statusBar.style.background = '#0D2D1A';
    statusBar.style.border = '1.5px solid #1A6B3A';
    statusBar.style.color = '#5CE88A';
    const totalMin = closeMin ? closeMin - openMin : null;
    const remainMin = closeMin ? closeMin - nowMin : null;
    statusBar.innerHTML = `ğŸŸ¢ å–¶æ¥­ä¸­ ${openVal}ã€œ${closeVal || '?'} ` +
      (remainMin !== null ? ` â€” æ®‹ã‚Šç´„ ${Math.floor(remainMin/60)}h${remainMin%60}m` : '');
  }
}

function onBizTimeChange() {
  updateBizElapsedDisplay();
  refreshMonitor();
}

// ============================================================
//  PARTNER HOURS FAST UPDATE (DOMå†æ§‹ç¯‰ãªã—)
// ============================================================
function updatePartnerHoursOnly() {
  const rows = document.querySelectorAll('.partner-row');
  rows.forEach(row => {
    const id = parseInt(row.dataset.id);
    const p = partners.find(x => x.id === id);
    if (!p) return;
    const wh = calcWorkedHours(p);
    const nonOpe = calcNonOpeHours(p);
    const hoursEl = row.querySelector('.partner-hours');
    if (hoursEl) {
      hoursEl.innerHTML = `<span style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:${wh >= 8 ? 'var(--orange)' : 'var(--green-bright)'};">${wh.toFixed(2)}h</span><br><span style="font-size:0.6rem;color:var(--text-dim);">ã‚ªãƒš / éã‚ªãƒš ${nonOpe.toFixed(2)}h</span>`;
    }
  });
}

// ============================================================
//  MONITOR REFRESH
// ============================================================
function refreshMonitor() {
  const salesVal = parseFloat(document.getElementById('mon-sales').value) || 0;
  const guideVal = parseFloat(document.getElementById('mon-guide').value) || config.defaultGuide;
  const actual = totalWorkedHours();

  // å–¶æ¥­çµŒéæ™‚é–“ãƒ™ãƒ¼ã‚¹ã§ã‚¬ã‚¤ãƒ‰æ™‚é–“ã‚’ç®—å‡º
  const bizElapsed = getBizElapsedHours();
  let guideH = 0;
  if (guideVal > 0 && salesVal > 0) {
    guideH = salesVal / guideVal;
  }

  const ratio = guideH > 0 ? (actual / guideH) * 100 : 0;
  const diff = actual - guideH;

  // Colors
  const rc = ratio >= config.dangerLine ? 'danger' : ratio >= config.warnLine ? 'warn' : 'ok';

  // Values
  document.getElementById('val-guide-h').textContent = guideH > 0 ? guideH.toFixed(2) : '--';
  document.getElementById('val-actual-h').textContent = actual.toFixed(2);
  document.getElementById('val-ratio').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '--%';
  const diffEl = document.getElementById('val-diff');
  diffEl.textContent = guideH > 0 ? (diff >= 0 ? '+' : '') + diff.toFixed(2) : '--';
  diffEl.className = 'metric-value ' + (diff > 0 ? 'danger' : 'ok');

  document.getElementById('val-headcount').textContent = partners.length;
  document.getElementById('val-retired-h').textContent = retiredHours.toFixed(2);

  // éã‚ªãƒšæ™‚é–“å†…è¨³ã‚’é›†è¨ˆã—ã¦è¡¨ç¤º
  const nonOpeBreak    = partners.reduce((s,p) => s + (p.breakMin||0), 0) / 60;
  const nonOpeMeeting  = partners.reduce((s,p) => s + (p.meetingMin||0), 0) / 60;
  const nonOpeTraining = partners.reduce((s,p) => s + (p.trainingMin||0), 0) / 60;
  const nonOpeExp      = partners.reduce((s,p) => s + (p.experienceMin||0), 0) / 60;
  const nonOpeCln      = partners.reduce((s,p) => s + (p.cleanlinessMin||0), 0) / 60;
  document.getElementById('nonope-break').textContent    = nonOpeBreak.toFixed(1);
  document.getElementById('nonope-meeting').textContent  = nonOpeMeeting.toFixed(1);
  document.getElementById('nonope-training').textContent = nonOpeTraining.toFixed(1);
  document.getElementById('nonope-exp').textContent      = nonOpeExp.toFixed(1);
  document.getElementById('nonope-cln').textContent      = nonOpeCln.toFixed(1);
  const nonOpeMgt = partners.reduce((s,p) => s + (p.managementMin||0), 0) / 60;
  document.getElementById('nonope-mgt').textContent = nonOpeMgt.toFixed(1);

  // Card colors
  ['mc-ratio','mc-diff'].forEach(id => {
    const el = document.getElementById(id);
    el.className = 'metric-card ' + rc;
  });
  document.getElementById('val-ratio').className = 'metric-value ' + rc;

  // Gauge
  const gaugePct = Math.min(ratio / 150 * 100, 100);
  const gFill = document.getElementById('gauge-mon');
  const gColor = rc === 'danger' ? 'var(--red)' : rc === 'warn' ? 'var(--orange)' : 'var(--green-bright)';
  gFill.style.width = gaugePct + '%';
  gFill.style.background = gColor;
  document.getElementById('gauge-mon-label').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '';
  document.getElementById('gauge-text-mon').textContent = ratio > 0 ? ratio.toFixed(1) + '%' : '--';

  // Verdict
  let verdict = '';
  if (ratio <= 0) {
    verdict = '';
  } else if (ratio < config.warnLine) {
    verdict = `<div class="verdict ok"><span class="verdict-icon">âœ…</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” é©æ­£ç¯„å›²å†…ã§ã™ã€‚åŠ´åƒæ™‚é–“ãŒã‚¬ã‚¤ãƒ‰ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚</div>`;
  } else if (ratio < config.dangerLine) {
    verdict = `<div class="verdict warn"><span class="verdict-icon">âš ï¸</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” æ³¨æ„ãƒ©ã‚¤ãƒ³è¶…éã€‚ç´„ ${Math.abs(diff).toFixed(1)} æ™‚é–“åˆ†ã®è¶…éã§ã™ã€‚ä¼‘æ†©èª¿æ•´ã‚„æ—©ä¸ŠãŒã‚Šã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</div>`;
  } else {
    verdict = `<div class="verdict danger"><span class="verdict-icon">ğŸ”´</span>ã‚¬ã‚¤ãƒ‰æ¯” ${ratio.toFixed(1)}% â€” å±é™ºãƒ©ã‚¤ãƒ³è¶…éï¼${Math.abs(diff).toFixed(1)} æ™‚é–“åˆ†ã®éå‰°åŠ´åƒã§ã™ã€‚æ—©æ€¥ãªäººå“¡èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚</div>`;
  }
  document.getElementById('verdict-mon').innerHTML = verdict;
}

// ============================================================
//  AUTO REFRESH (5 min)
// ============================================================
function startAutoRefresh() {
  countdownSec = config.intervalSec;
  clearInterval(autoTimer);
  clearInterval(countdownTimer);
  autoTimer = setInterval(() => {
    renderPartners();
    refreshMonitor();
    countdownSec = config.intervalSec;
  }, config.intervalSec * 1000);
  countdownTimer = setInterval(() => {
    countdownSec = Math.max(0, countdownSec - 1);
    const m = Math.floor(countdownSec / 60);
    const s = countdownSec % 60;
    document.getElementById('val-countdown').textContent =
      String(m).padStart(1,'0') + ':' + String(s).padStart(2,'0');
  }, 1000);
}

// ============================================================
//  SNAPSHOT / HISTORY
// ============================================================
function saveSnapshot() {
  const sales = parseFloat(document.getElementById('mon-sales').value) || 0;
  const guide = parseFloat(document.getElementById('mon-guide').value) || config.defaultGuide;
  const actual = totalWorkedHours();
  const guideH = guide > 0 ? sales / guide : 0;
  const ratio = guideH > 0 ? (actual / guideH) * 100 : 0;
  const now = new Date();
  const snap = {
    id: Date.now(),
    date: now.toLocaleDateString('ja-JP'),
    time: now.toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'}),
    sales, guide, guideH: guideH.toFixed(2), actual: actual.toFixed(2),
    ratio: ratio.toFixed(1), headcount: partners.length,
    partnerNames: partners.map(p => p.name).join(', ')
  };
  history.unshift(snap);
  if (history.length > 200) history = history.slice(0, 200);
  persist();
  alert(`ä¿å­˜ã—ã¾ã—ãŸï¼\nã‚¬ã‚¤ãƒ‰æ¯”: ${ratio.toFixed(1)}%`);
}

function renderHistory() {
  const list = document.getElementById('history-list');
  const empty = document.getElementById('history-empty');
  if (!history.length) { list.innerHTML=''; list.appendChild(empty); return; }
  empty.style.display = 'none';
  list.innerHTML = '';
  // Group by date
  const grouped = {};
  history.forEach(h => {
    if (!grouped[h.date]) grouped[h.date] = [];
    grouped[h.date].push(h);
  });
  Object.entries(grouped).forEach(([date, entries]) => {
    const dateHeader = document.createElement('div');
    dateHeader.style.cssText = 'font-size:0.72rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin:16px 0 8px;padding:0 4px;';
    dateHeader.textContent = date;
    list.appendChild(dateHeader);
    entries.forEach(h => {
      const rc = parseFloat(h.ratio) >= config.dangerLine ? 'danger' : parseFloat(h.ratio) >= config.warnLine ? 'warn' : 'ok';
      const el = document.createElement('div');
      el.className = 'history-entry';
      el.innerHTML = `
        <div class="hist-header">
          <div>
            <div class="hist-date">${h.date} ${h.time}</div>
            <div class="hist-guide">ã‚¬ã‚¤ãƒ‰å˜ä¾¡ Â¥${h.guide?.toLocaleString()} ï¼ å‡ºå‹¤ ${h.headcount}å</div>
          </div>
          <button class="delete-hist" onclick="deleteHistory(${h.id})">âœ•</button>
        </div>
        <div class="hist-metrics">
          <div class="hist-metric"><div class="hist-val" style="color:var(--text)">Â¥${(h.sales||0).toLocaleString()}</div><div class="hist-lbl">å£²ä¸Š</div></div>
          <div class="hist-metric"><div class="hist-val">${h.guideH}h</div><div class="hist-lbl">ã‚¬ã‚¤ãƒ‰æ™‚é–“</div></div>
          <div class="hist-metric"><div class="hist-val">${h.actual}h</div><div class="hist-lbl">å®ŸåŠ´åƒæ™‚é–“</div></div>
          <div class="hist-metric"><div class="hist-val ${rc}">${h.ratio}%</div><div class="hist-lbl">ã‚¬ã‚¤ãƒ‰æ¯”</div></div>
        </div>
        ${h.partnerNames ? `<div style="margin-top:8px;font-size:0.7rem;color:var(--text-dim);">å‡ºå‹¤: ${h.partnerNames}</div>` : ''}
      `;
      list.appendChild(el);
    });
  });
}

function deleteHistory(id) {
  history = history.filter(h => h.id !== id);
  persist();
  renderHistory();
}

// ============================================================
//  CONFIG
// ============================================================
function saveConfig() {
  config.store = document.getElementById('cfg-store').value || 'åº—èˆ—å';
  config.defaultGuide = parseFloat(document.getElementById('cfg-guide').value) || 7665;
  config.warnLine = parseFloat(document.getElementById('cfg-warn').value) || 105;
  config.dangerLine = parseFloat(document.getElementById('cfg-danger').value) || 115;
  config.intervalSec = parseInt(document.getElementById('cfg-interval').value) || 300;
  document.getElementById('hdr-store').textContent = config.store;
  persist();
  startAutoRefresh();
  refreshMonitor();
}

function exportData() {
  const rows = ['æ—¥ä»˜,æ™‚åˆ»,å£²ä¸Š,ã‚¬ã‚¤ãƒ‰å˜ä¾¡,ã‚¬ã‚¤ãƒ‰æ™‚é–“,å®ŸåŠ´åƒæ™‚é–“,ã‚¬ã‚¤ãƒ‰æ¯”(%),å‡ºå‹¤äººæ•°,ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'];
  history.forEach(h => {
    rows.push([h.date, h.time, h.sales, h.guide, h.guideH, h.actual, h.ratio, h.headcount, `"${h.partnerNames||''}"`].join(','));
  });
  const blob = new Blob(['\uFEFF' + rows.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'sbcj_labor_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

function clearToday() {
  if (!confirm('æœ¬æ—¥ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  partners = [];
  retiredHours = 0;
  document.getElementById('mon-sales').value = '';
  persist();
  renderPartners();
  refreshMonitor();
}

function clearAll() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå±¥æ­´å«ã‚€ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  partners = []; history = []; retiredHours = 0;
  persist();
  renderPartners();
  refreshMonitor();
  renderHistory();
}

// ============================================================
//  EDIT MODAL
// ============================================================
function openEditModal(id) {
  const p = partners.find(x => x.id === id);
  if (!p) return;
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-name').value = p.name;
  document.getElementById('edit-start').value = p.start;
  document.getElementById('edit-end').value = p.end || '';
  document.getElementById('edit-break').value = p.breakMin || 0;
  document.getElementById('edit-meeting').value = p.meetingMin || 0;
  document.getElementById('edit-training').value = p.trainingMin || 0;
  document.getElementById('edit-experience').value = p.experienceMin || 0;
  document.getElementById('edit-cleanliness').value = p.cleanlinessMin || 0;
  document.getElementById('edit-management').value = p.managementMin || 0;
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('open');
}

function saveEdit() {
  const id = parseInt(document.getElementById('edit-id').value);
  const name = document.getElementById('edit-name').value.trim();
  const start = document.getElementById('edit-start').value;
  const end = document.getElementById('edit-end').value;
  const brk = parseInt(document.getElementById('edit-break').value) || 0;
  if (!name || !start) { alert('æ°åã¨å‡ºç¤¾æ™‚åˆ»ã¯å¿…é ˆã§ã™'); return; }
  const p = partners.find(x => x.id === id);
  if (p) {
    p.name = name;
    p.start = start;
    p.end = end;
    p.breakMin = brk;
    p.meetingMin = parseInt(document.getElementById('edit-meeting').value) || 0;
    p.trainingMin = parseInt(document.getElementById('edit-training').value) || 0;
    p.experienceMin = parseInt(document.getElementById('edit-experience').value) || 0;
    p.cleanlinessMin = parseInt(document.getElementById('edit-cleanliness').value) || 0;
    p.managementMin = parseInt(document.getElementById('edit-management').value) || 0;
    persist();
    renderPartners();
    updateBizElapsedDisplay();
    refreshMonitor();
  }
  closeEditModal();
}

// ============================================================
//  INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  load();
  // Apply config to UI
  document.getElementById('cfg-store').value = config.store;
  document.getElementById('cfg-guide').value = config.defaultGuide;
  document.getElementById('cfg-warn').value = config.warnLine;
  document.getElementById('cfg-danger').value = config.dangerLine;
  document.getElementById('cfg-interval').value = config.intervalSec;
  document.getElementById('hdr-store').textContent = config.store;
  document.getElementById('mon-guide').value = config.defaultGuide;

  setInterval(updateClock, 1000);
  updateClock();
  renderPartners();
  updateBizElapsedDisplay();
  refreshMonitor();
  startAutoRefresh();

  // åŠ´åƒæ™‚é–“ã¯5ç§’ã”ã¨ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  setInterval(() => {
    updateBizElapsedDisplay();
    refreshMonitor();
  }, 1000);
  // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¡Œã®åŠ´åƒæ™‚é–“æ•°å­—ã ã‘æ¯ç§’æ›´æ–°ï¼ˆDOMå†æ§‹ç¯‰ãªã—ï¼‰
  setInterval(updatePartnerHoursOnly, 1000);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
  document.getElementById('edit-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
  });
});
</script>

<!-- ========== EDIT MODAL ========== -->

<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">âœï¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æƒ…å ±ã‚’ç·¨é›†</div>
    <input type="hidden" id="edit-id">
    <div class="modal-grid">
      <div class="field" style="grid-column:1/-1;">
        <label>æ°å</label>
        <input type="text" id="edit-name">
      </div>
      <div class="field">
        <label>å‡ºç¤¾æ™‚åˆ»</label>
        <input type="time" id="edit-start">
      </div>
      <div class="field">
        <label>é€€ç¤¾äºˆå®šæ™‚åˆ»</label>
        <input type="time" id="edit-end">
      </div>
      <div class="field">
        <label>ğŸ›Œ ä¼‘æ†© (åˆ†)</label>
        <input type="number" id="edit-break" min="0" max="480" inputmode="numeric">
      </div>
      <div class="field">
        <label>ğŸ“‹ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚° (åˆ†)</label>
        <input type="number" id="edit-meeting" min="0" max="480" inputmode="numeric">
      </div>
      <div class="field">
        <label>ğŸŒ± è‚²æˆ (åˆ†)</label>
        <input type="number" id="edit-training" min="0" max="480" inputmode="numeric">
      </div>
      <div class="field">
        <label>âœ¨ ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ (åˆ†)</label>
        <input type="number" id="edit-experience" min="0" max="480" inputmode="numeric">
      </div>
      <div class="field">
        <label>ğŸ§¹ ã‚¯ãƒ¬ãƒªãƒã‚¹ (åˆ†)</label>
        <input type="number" id="edit-cleanliness" min="0" max="480" inputmode="numeric">
      </div>
      <div class="field">
        <label>ğŸ’¼ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ (åˆ†)</label>
        <input type="number" id="edit-management" min="0" max="480" inputmode="numeric">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

</body>
</html>
